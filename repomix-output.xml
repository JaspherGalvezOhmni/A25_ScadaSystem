This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
dashboard-ui/
  public/
    Ohmni Logo.png
    Ohmni_Logo_RGB_Blue_WhiteBG.svg
    Ohmni_Logo_RGB_Blue.svg
    ohmni_pty_ltd_logo.svg
    vite.svg
  src/
    assets/
      react.svg
    components/
      CommandsSidebar.jsx
      FlywheelVisual.jsx
      HealthStatus.jsx
      PensSidebar.jsx
      PopoutWindow.jsx
      ProtectedRoute.jsx
      StreamingChart.jsx
    constants/
      index.js
    context/
      AuthContext.jsx
      SystemStatusContext.jsx
    pages/
      EngineeringPage.jsx
      HomePage.jsx
      LoginPage.jsx
      OperationalDetailsPage.jsx
      SensorWallPage.jsx
    api.js
    App.css
    App.jsx
    index.css
    main.jsx
  .gitignore
  eslint.config.js
  index.html
  package.json
  README.md
  vite.config.js
.gitignore
docker-compose.yml
Dockerfile.backend
Dockerfile.frontend
hash_password.py
main_api.py
nginx.conf
requirements.txt
test_db_insert.py
test_db_read.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="dashboard-ui/public/Ohmni_Logo_RGB_Blue_WhiteBG.svg">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 1070 230" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g>
        <path d="M73.96,83.92L73.96,219.11C73.96,223.19 68.86,225.18 65.97,222.23L1.28,156.2C0.46,155.36 0,154.24 0,153.08L0,83.92C0,81.42 2.08,79.4 4.64,79.4L69.33,79.4C71.89,79.4 73.97,81.42 73.97,83.92" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
        <path d="M89.31,155.19L198.63,155.19C202.85,155.19 204.88,160.38 201.78,163.26L137.87,222.59C137.01,223.38 135.89,223.83 134.72,223.83L89.31,223.83C86.75,223.83 84.67,221.75 84.67,219.18L84.67,159.85C84.67,157.28 86.74,155.2 89.31,155.2" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
        <path d="M296.6,223.82L165.21,223.82C160.99,223.82 158.96,218.63 162.06,215.75L225.97,156.42C226.83,155.62 227.95,155.18 229.12,155.18L296.6,155.18C299.16,155.18 301.24,157.26 301.24,159.83L301.24,219.16C301.24,221.73 299.17,223.81 296.6,223.81" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
        <path d="M227.33,140.06L227.33,4.91C227.33,0.83 232.43,-1.16 235.32,1.79L300.01,67.8C300.83,68.64 301.29,69.76 301.29,70.92L301.29,140.06C301.29,142.56 299.21,144.58 296.65,144.58L231.96,144.58C229.4,144.58 227.32,142.56 227.32,140.06" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
        <path d="M211.93,68.63L102.61,68.63C98.39,68.63 96.36,63.44 99.46,60.56L163.37,1.24C164.23,0.44 165.35,0 166.52,0L211.93,0C214.49,0 216.57,2.08 216.57,4.65L216.57,63.98C216.57,66.55 214.5,68.63 211.93,68.63" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
        <path d="M4.64,0L136.03,0C140.25,0 142.28,5.19 139.18,8.07L75.27,67.4C74.41,68.2 73.29,68.64 72.12,68.64L4.64,68.64C2.08,68.63 0,66.55 0,63.98L0,4.65C0,2.08 2.08,0 4.64,0" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
    </g>
    <g>
        <path d="M430.75,203.19C467.33,203.19 488.54,176.86 488.54,133.25C488.54,89.64 467.33,62.24 430.75,62.24C394.17,62.24 373.23,88.83 373.23,133.25C373.23,177.67 394.44,203.19 430.75,203.19M430.75,229.51C375.61,229.51 339.56,190.42 339.56,132.98C339.56,75.54 375.35,35.91 430.75,35.91C486.15,35.91 521.94,73.14 521.94,133.24C521.94,193.34 485.62,229.51 430.75,229.51" style="fill:white;fill-rule:nonzero;"/>
        <path d="M604.39,110.37C588.75,110.37 573.9,122.87 569.4,146.27L570.2,223.66C570.2,224.73 569.14,225.79 568.08,225.79L540.51,225.79C539.45,225.79 538.39,224.73 538.39,223.66L539.45,131.91L538.39,41.76C538.39,40.7 539.45,39.63 540.51,39.63L568.08,39.63C569.14,39.63 570.2,40.7 570.2,41.76L569.67,107.18C578.68,94.15 593,85.64 612.62,85.64C642.31,85.64 660.6,103.72 660.07,143.61L660.07,172.06L660.6,223.65C660.6,224.72 659.54,225.78 658.48,225.78L630.11,225.78C629.05,225.78 627.99,224.72 627.99,223.65L628.79,172.59L628.52,140.15C628.52,119.41 617.92,110.36 604.4,110.36" style="fill:white;fill-rule:nonzero;"/>
        <path d="M711.49,174.73L712.29,223.66C712.29,224.72 711.23,225.79 710.17,225.79L681.28,225.79C680.22,225.79 679.16,224.73 679.16,223.66L679.96,174.73L679.69,90.96C679.69,89.9 680.75,88.83 681.81,88.83L708.58,88.83C709.64,88.83 710.7,89.89 710.7,90.96L709.9,108.78C718.92,94.95 731.64,85.64 750.72,85.64C769.8,85.64 783.59,94.15 789.95,112.77C800.82,93.09 814.34,85.64 832.1,85.64C859.14,85.64 875.05,102.4 875.05,139.36L875.05,174.73L875.84,223.66C875.84,224.72 874.78,225.79 873.72,225.79L845.35,225.79C844.29,225.79 843.23,224.73 843.23,223.66L843.76,174.73L843.76,140.16C843.76,119.42 835.28,110.64 821.76,110.64C809.56,110.64 797.64,123.4 793.66,146.54L793.66,174.73L794.19,223.66C794.19,224.72 793.13,225.79 792.07,225.79L763.7,225.79C762.64,225.79 761.58,224.73 761.58,223.66L762.38,174.73L762.38,140.16C762.38,119.42 753.9,110.64 740.38,110.64C726.86,110.64 714.14,125.53 711.48,152.66L711.48,174.73L711.49,174.73Z" style="fill:white;fill-rule:nonzero;"/>
        <path d="M896.26,225.79C895.2,225.79 894.14,224.73 894.14,223.66L894.94,161.43L894.67,90.96C894.67,89.9 895.73,88.83 896.79,88.83L923.56,88.83C924.62,88.83 925.68,89.89 925.68,90.96L924.89,108.78C933.64,96.01 949.28,85.64 969.69,85.64C998.06,85.64 1016.35,104.79 1016.35,139.36L1016.35,167.55L1016.88,223.66C1016.88,224.73 1015.82,225.79 1014.76,225.79L986.66,225.79C985.6,225.79 984.54,224.73 984.54,223.66L985.07,167.55L985.07,140.16C985.07,120.75 974.73,110.64 960.15,110.64C944.24,110.64 929.13,124.2 926.48,152.66L926.48,167.55L927.01,223.66C927.01,224.73 925.95,225.79 924.89,225.79L896.26,225.79Z" style="fill:white;fill-rule:nonzero;"/>
        <path d="M1038.61,225.79C1037.55,225.79 1036.49,224.73 1036.49,223.66L1037.02,156.38L1036.49,90.96C1036.49,89.9 1037.55,88.83 1038.61,88.83L1066.98,88.83C1068.04,88.83 1069.1,89.89 1069.1,90.96L1068.3,156.38L1069.1,223.66C1069.1,224.73 1068.04,225.79 1066.98,225.79L1038.61,225.79Z" style="fill:white;fill-rule:nonzero;"/>
        <path d="M1038.64,78.07C1037.57,78.07 1036.5,76.97 1036.5,75.88L1036.5,47.67C1036.5,46.58 1037.57,45.48 1038.64,45.48L1066.96,45.48C1068.03,45.48 1069.1,46.58 1069.1,47.67L1069.1,75.88C1069.1,76.97 1068.03,78.07 1066.96,78.07L1038.64,78.07Z" style="fill:rgb(30,240,240);fill-rule:nonzero;"/>
    </g>
</svg>
</file>

<file path="dashboard-ui/public/Ohmni_Logo_RGB_Blue.svg">
<?xml version="1.0" encoding="UTF-8"?>
<svg id="Logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1069.1 229.51">
  <defs>
    <style>
      .cls-1 {
        fill: #1ef0f0;
      }

      .cls-1, .cls-2 {
        stroke-width: 0px;
      }

      .cls-2 {
        fill: #231f20;
      }
    </style>
  </defs>
  <g>
    <path class="cls-1" d="M73.96,83.92v135.19c0,4.08-5.1,6.07-7.99,3.12L1.28,156.2c-.82-.84-1.28-1.96-1.28-3.12v-69.16c0-2.5,2.08-4.52,4.64-4.52h64.69c2.56,0,4.64,2.02,4.64,4.52"/>
    <path class="cls-1" d="M89.31,155.19h109.32c4.22,0,6.25,5.19,3.15,8.07l-63.91,59.33c-.86.79-1.98,1.24-3.15,1.24h-45.41c-2.56,0-4.64-2.08-4.64-4.65v-59.33c0-2.57,2.07-4.65,4.64-4.65"/>
    <path class="cls-1" d="M296.6,223.82h-131.39c-4.22,0-6.25-5.19-3.15-8.07l63.91-59.33c.86-.8,1.98-1.24,3.15-1.24h67.48c2.56,0,4.64,2.08,4.64,4.65v59.33c0,2.57-2.07,4.65-4.64,4.65"/>
    <path class="cls-1" d="M227.33,140.06V4.91c0-4.08,5.1-6.07,7.99-3.12l64.69,66.01c.82.84,1.28,1.96,1.28,3.12v69.14c0,2.5-2.08,4.52-4.64,4.52h-64.69c-2.56,0-4.64-2.02-4.64-4.52"/>
    <path class="cls-1" d="M211.93,68.63h-109.32c-4.22,0-6.25-5.19-3.15-8.07L163.37,1.24c.86-.8,1.98-1.24,3.15-1.24h45.41c2.56,0,4.64,2.08,4.64,4.65v59.33c0,2.57-2.07,4.65-4.64,4.65"/>
    <path class="cls-1" d="M4.64,0h131.39c4.22,0,6.25,5.19,3.15,8.07l-63.91,59.33c-.86.8-1.98,1.24-3.15,1.24H4.64C2.08,68.63,0,66.55,0,63.98V4.65C0,2.08,2.08,0,4.64,0"/>
  </g>
  <g>
    <path class="cls-2" d="M430.75,203.19c36.58,0,57.79-26.33,57.79-69.94s-21.21-71.01-57.79-71.01-57.52,26.59-57.52,71.01,21.21,69.94,57.52,69.94M430.75,229.51c-55.14,0-91.19-39.09-91.19-96.53s35.79-97.07,91.19-97.07,91.19,37.23,91.19,97.33-36.32,96.27-91.19,96.27"/>
    <path class="cls-2" d="M604.39,110.37c-15.64,0-30.49,12.5-34.99,35.9l.8,77.39c0,1.07-1.06,2.13-2.12,2.13h-27.57c-1.06,0-2.12-1.06-2.12-2.13l1.06-91.75-1.06-90.15c0-1.06,1.06-2.13,2.12-2.13h27.57c1.06,0,2.12,1.07,2.12,2.13l-.53,65.42c9.01-13.03,23.33-21.54,42.95-21.54,29.69,0,47.98,18.08,47.45,57.97v28.45l.53,51.59c0,1.07-1.06,2.13-2.12,2.13h-28.37c-1.06,0-2.12-1.06-2.12-2.13l.8-51.06-.27-32.44c0-20.74-10.6-29.79-24.12-29.79"/>
    <path class="cls-2" d="M711.49,174.73l.8,48.93c0,1.06-1.06,2.13-2.12,2.13h-28.89c-1.06,0-2.12-1.06-2.12-2.13l.8-48.93-.27-83.77c0-1.06,1.06-2.13,2.12-2.13h26.77c1.06,0,2.12,1.06,2.12,2.13l-.8,17.82c9.02-13.83,21.74-23.14,40.82-23.14s32.87,8.51,39.23,27.13c10.87-19.68,24.39-27.13,42.15-27.13,27.04,0,42.95,16.76,42.95,53.72v35.37l.79,48.93c0,1.06-1.06,2.13-2.12,2.13h-28.37c-1.06,0-2.12-1.06-2.12-2.13l.53-48.93v-34.57c0-20.74-8.48-29.52-22-29.52-12.2,0-24.12,12.76-28.1,35.9v28.19l.53,48.93c0,1.06-1.06,2.13-2.12,2.13h-28.37c-1.06,0-2.12-1.06-2.12-2.13l.8-48.93v-34.57c0-20.74-8.48-29.52-22-29.52s-26.24,14.89-28.9,42.02v22.07Z"/>
    <path class="cls-2" d="M896.26,225.79c-1.06,0-2.12-1.06-2.12-2.13l.8-62.23-.27-70.47c0-1.06,1.06-2.13,2.12-2.13h26.77c1.06,0,2.12,1.06,2.12,2.13l-.79,17.82c8.75-12.77,24.39-23.14,44.8-23.14,28.37,0,46.66,19.15,46.66,53.72v28.19l.53,56.11c0,1.07-1.06,2.13-2.12,2.13h-28.1c-1.06,0-2.12-1.06-2.12-2.13l.53-56.11v-27.39c0-19.41-10.34-29.52-24.92-29.52-15.91,0-31.02,13.56-33.67,42.02v14.89l.53,56.11c0,1.07-1.06,2.13-2.12,2.13h-28.63Z"/>
    <path class="cls-2" d="M1038.61,225.79c-1.06,0-2.12-1.06-2.12-2.13l.53-67.28-.53-65.42c0-1.06,1.06-2.13,2.12-2.13h28.37c1.06,0,2.12,1.06,2.12,2.13l-.8,65.42.8,67.28c0,1.07-1.06,2.13-2.12,2.13h-28.37Z"/>
    <path class="cls-1" d="M1038.64,78.07c-1.07,0-2.14-1.1-2.14-2.19v-28.21c0-1.09,1.07-2.19,2.14-2.19h28.32c1.07,0,2.14,1.1,2.14,2.19v28.21c0,1.09-1.07,2.19-2.14,2.19h-28.32Z"/>
  </g>
</svg>
</file>

<file path="dashboard-ui/public/ohmni_pty_ltd_logo.svg">
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="200.000000pt" height="200.000000pt" viewBox="0 0 200.000000 200.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,200.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M0 1000 l0 -1000 1000 0 1000 0 0 1000 0 1000 -1000 0 -1000 0 0
-1000z m948 489 c2 -10 -54 -68 -144 -152 l-148 -137 -168 0 -168 0 0 149 c0
110 3 151 13 154 6 3 147 4 312 3 265 -1 300 -3 303 -17z m341 8 c8 -10 11
-57 9 -153 l-3 -139 -259 -3 c-161 -1 -263 1 -270 8 -10 10 -14 7 180 186
l119 110 106 3 c82 1 108 -1 118 -12z m239 -150 l153 -153 -3 -169 -3 -170
-160 0 -160 0 -3 323 c-2 256 0 322 10 322 8 0 82 -69 166 -153z m-880 -525
c2 -304 1 -323 -15 -320 -10 2 -84 71 -165 154 l-148 151 0 166 c0 123 3 167
13 171 6 2 80 4 162 3 l150 -2 3 -323z m586 -31 c8 -12 -10 -31 -164 -173
l-135 -124 -97 -3 c-143 -3 -138 -8 -138 158 0 76 3 141 7 144 10 11 521 8
527 -2z m446 -141 c0 -82 -3 -150 -7 -150 -5 0 -145 0 -313 -1 -260 -1 -305 1
-308 14 -2 8 61 74 144 151 l147 136 169 0 168 0 0 -150z"/>
</g>
</svg>
</file>

<file path="dashboard-ui/public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="dashboard-ui/src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="dashboard-ui/src/components/FlywheelVisual.jsx">
// src/components/FlywheelSystemVisual.jsx

import React from 'react';
import HealthStatus from './HealthStatus';

// Tag mapping from your Picture 1 layout
const TAG_MAP = {
  // Command Status
  chargeStatus: 'A25_CMD_Charge',
  dischargeStatus: 'A25_CMD_Discharge',
  shutdownStatus: 'A25_CMD_Shutdown',
  startupStatus: 'A25_CMD_Startup',
  
  // Power/Energy
  power: 'A25_Power',
  speed: 'A25_Speed',
  energy: 'A25_Energy', // Energy Stored / State of Charge source
  soc: 'A25_SoC',
  energyTotal: 'A25_Energy_Total',
  cycles: 'A25_Cycles',
  runHours: 'A25_RunHours',
  status: 'A25_Status',
  
  // Health/Vibration/Temp
  tempUpper: 'TT001.Scaled',
  tempLower: 'TT002.Scaled',
  tempMotor: 'TT003.Scaled',
  vibUpper: 'VT001.Scaled',
  vibLower: 'VT002.Scaled',
  loadCell: 'WT001_Scaled',
  pressure: 'PT001_Scaled',
  
  // Health Status (Boolean)
  healthLoadCell: 'WT001_Healthy',
  healthVibUpper: 'VT001_Healthy',
  healthVibLower: 'VT002_Healthy',
  healthPressure: 'PT001_Healthy',
  healthTempUpper: 'TT001_Healthy',
  healthTempLower: 'TT002_Healthy',
  healthTempMotor: 'TT003_Healthy',
};

// Map status number to descriptive text
const getFlywheelStatusText = (statusCode) => {
    switch(statusCode) {
        case 0: return 'Shutdown';
        case 1: return 'Idle (Standby)';
        case 2: return 'Charging';
        case 3: return 'Discharging';
        case 4: return 'Fault';
        default: return 'Unknown';
    }
}

// Function to render the flywheel graphic with embedded tags
function FlywheelGraphic({ tags }) {
    
    // NOTE: 'tags' is already defaulted to {} in the parent component
    const currentPower = tags[TAG_MAP.power] || 0;
    const isCharging = currentPower > 0.5;
    const isDischarging = currentPower < -0.5;

    // Arrow visual logic
    let arrowDirection = '—'; // Idle/Brake/Shutdown
    let arrowClass = 'flow-idle';
    if (isCharging) {
        arrowDirection = '↓'; 
        arrowClass = 'flow-charge'; // Grid -> AC Network -> Flywheel
    } else if (isDischarging) {
        arrowDirection = '↑';
        arrowClass = 'flow-discharge'; // Flywheel -> AC Network -> Grid
    }

    return (
        <div className="flywheel-system-visual-container">
            {/* The main diagram using CSS Grid for structure */}
            <div className="flywheel-diagram">

                {/* Left Command Side */}
                <div className="command-indicators">
                    {/* The tags object is safe (guaranteed by parent) */}
                    <span className={`tag-label tag-charge ${tags[TAG_MAP.chargeStatus] ? 'active' : ''}`}>{TAG_MAP.chargeStatus}</span>
                    <span className={`tag-label tag-discharge ${tags[TAG_MAP.dischargeStatus] ? 'active' : ''}`}>{TAG_MAP.dischargeStatus}</span>
                    <span className={`tag-label tag-shutdown ${tags[TAG_MAP.shutdownStatus] ? 'active' : ''}`}>{TAG_MAP.shutdownStatus}</span>
                    <span className={`tag-label tag-startup ${tags[TAG_MAP.startupStatus] ? 'active' : ''}`}>{TAG_MAP.startupStatus}</span>
                </div>

                {/* Center Flywheel Stack */}
                <div className="flywheel-stack">
                    
                    {/* Top Section */}
                    <div className="flywheel-section-top">
                        <div className="ac-network-box">AC Network</div>
                        <div className={`power-flow-arrow ${arrowClass}`}>{arrowDirection}</div>
                        <div className="power-readout">
                            {/* Power Readout */}
                            <span className="power-value">{currentPower.toFixed(2)} kW</span>
                            <span className="power-tag-label">{TAG_MAP.power}</span>
                        </div>
                    </div>
                    
                    {/* The Flywheel Body (Visual) */}
                    <div className="flywheel-body">
                        {/* Internal Sensors & Health */}
                        <div className="sensor-zone-left">
                            <div className="sensor-group-item">
                                <span className="tag-label">{TAG_MAP.loadCell}</span>
                                <HealthStatus value={tags[TAG_MAP.healthLoadCell]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                            <div className="sensor-group-item">
                                <span className="tag-label">{TAG_MAP.vibUpper}</span>
                                <HealthStatus value={tags[TAG_MAP.healthVibUpper]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                            <div className="sensor-group-item">
                                <span className="tag-label">{TAG_MAP.pressure}</span>
                                <HealthStatus value={tags[TAG_MAP.healthPressure]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                            <div className="sensor-group-item bottom-left">
                                <span className="tag-label">{TAG_MAP.vibLower}</span>
                                <HealthStatus value={tags[TAG_MAP.healthVibLower]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                        </div>

                        <div className="rotor-fill">
                           <span className="rotor-text">Flywheel Rotor</span>
                        </div>

                        <div className="sensor-zone-right">
                            <div className="sensor-group-item">
                                <span className="tag-label">{TAG_MAP.tempUpper}</span>
                                <HealthStatus value={tags[TAG_MAP.healthTempUpper]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                            <div className="sensor-group-item">
                                <span className="tag-label">{TAG_MAP.tempLower}</span>
                                <HealthStatus value={tags[TAG_MAP.healthTempLower]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                            <div className="sensor-group-item bottom-right">
                                <span className="tag-label">{TAG_MAP.tempMotor}</span>
                                <HealthStatus value={tags[TAG_MAP.healthTempMotor]} healthyText="Healthy" unhealthyText="FAULT" />
                            </div>
                        </div>
                    </div>
                    {/* Flywheel Base/Stand */}
                    <div className="flywheel-base"></div>
                </div>

                {/* Right Status Overview Indicators */}
                <div className="status-indicators">
                    <span className="tag-label tag-status">{TAG_MAP.status}</span>
                    <span className="tag-label tag-power">{TAG_MAP.power}</span>
                    <span className="tag-label tag-energy">{TAG_MAP.energy}</span>
                    <span className="tag-label tag-soc">{TAG_MAP.soc}</span>
                    <span className="tag-label tag-speed">{TAG_MAP.speed}</span>
                    <span className="tag-label tag-energy-total">{TAG_MAP.energyTotal}</span>
                    <span className="tag-label tag-cycles">{TAG_MAP.cycles}</span>
                    <span className="tag-label tag-runhours">{TAG_MAP.runHours}</span>
                </div>
            </div>
        </div>
    );
}

// Main component, replacing FlywheelVisual
function FlywheelVisual({ liveData }) {
    // FIX: Add optional chaining to safely access liveData.tags
    const tags = liveData?.tags || {};

    return (
        <div className="flywheel-main-visual">
            <FlywheelGraphic tags={tags} />
        </div>
    );
}

export default FlywheelVisual;
</file>

<file path="dashboard-ui/src/components/HealthStatus.jsx">
function HealthStatus({ title, value, isHealthy, healthyText = "OK", unhealthyText = "FAULT" }) {
  const finalIsHealthy = isHealthy !== undefined ? isHealthy : value;
  let statusClass;
  let displayText;

  if (finalIsHealthy === true) {
    statusClass = 'healthy';
    displayText = healthyText;
  } else if (finalIsHealthy === false) {
    statusClass = 'unhealthy';
    displayText = unhealthyText;
  } else {
    statusClass = 'unknown';
    displayText = 'N/A';
  }

  return (
    <div className={`health-item ${statusClass}`}>
      <span>{title}</span>
      <span className="health-indicator">{displayText}</span>
    </div>
  );
}
export default HealthStatus;
</file>

<file path="dashboard-ui/src/components/PensSidebar.jsx">
// src/components/PensSidebar.jsx
import { tagColorMap } from '../constants';

function PensSidebar({ chartDefinitions, visiblePens, onTogglePen }) {
  // Safety check
  if (!chartDefinitions || !Array.isArray(chartDefinitions)) {
      return null;
  }
  
  return (
    <div className="sidebar pens-sidebar">
      <h2>Chart Pens</h2>
      {chartDefinitions.map(chart => (
        <div key={chart.title} className="pen-group">
          <h4>{chart.title}</h4>
          {Array.isArray(chart.tags) && chart.tags.map(penName => (
            <div className="pen-item" key={penName}>
              <div 
                className="pen-color-swatch" 
                style={{ backgroundColor: tagColorMap[penName] }}
              ></div>
              <input
                type="checkbox"
                id={`pen-${chart.title}-${penName}`} // Unique ID
                // Check if this pen is in the visible list for this specific chart
                checked={visiblePens[chart.title]?.includes(penName) || false}
                onChange={() => onTogglePen(chart.title, penName)}
              />
              <label htmlFor={`pen-${chart.title}-${penName}`}>{penName}</label>
            </div>
          ))}
        </div>
      ))}
    </div>
  );
}

export default PensSidebar;
</file>

<file path="dashboard-ui/src/components/PopoutWindow.jsx">
import React, { useEffect, useState, useRef } from 'react';
import { createPortal } from 'react-dom';

function PopoutWindow({ title, onClose, children }) {
  const [container, setContainer] = useState(null);
  const externalWindowRef = useRef(null);

  useEffect(() => {
    // 1. Open the window
    const externalWindow = window.open(
      '', 
      '', 
      `width=800,height=600,left=200,top=200,resizable,scrollbars,status`
    );

    if (!externalWindow) {
        alert("Pop-up blocked! Please allow pop-ups for this site.");
        if (onClose) onClose();
        return;
    }

    externalWindowRef.current = externalWindow;
    
    // 2. Wait for window to load before manipulating (Important for some browsers)
    externalWindow.document.title = title || 'Ohmni Pop-out';
    
    // 3. Create Container
    const div = externalWindow.document.createElement('div');
    div.setAttribute('id', 'popout-root');
    // Force dark theme immediately to prevent white flash
    div.style.backgroundColor = '#1e1e1e'; 
    div.style.minHeight = '100vh';
    div.style.color = '#dcdcdc';
    div.style.boxSizing = 'border-box';
    
    externalWindow.document.body.appendChild(div);
    externalWindow.document.body.style.margin = '0';
    externalWindow.document.body.style.backgroundColor = '#1e1e1e';

    // 4. Copy CSS - Filtered to prevent CORS errors on external stylesheets
    Array.from(document.styleSheets).forEach((styleSheet) => {
      try {
        if (styleSheet.href) {
          const newLink = externalWindow.document.createElement('link');
          newLink.rel = 'stylesheet';
          newLink.href = styleSheet.href;
          externalWindow.document.head.appendChild(newLink);
        } else if (styleSheet.cssRules) {
          const newStyle = externalWindow.document.createElement('style');
          Array.from(styleSheet.cssRules).forEach((rule) => {
            newStyle.appendChild(externalWindow.document.createTextNode(rule.cssText));
          });
          externalWindow.document.head.appendChild(newStyle);
        }
      } catch (e) {
        // console.warn("Could not copy stylesheet:", e);
      }
    });

    setContainer(div);

    // 5. Cleanup Listener
    const handleBeforeUnload = () => {
        if (onClose) onClose();
    };
    externalWindow.addEventListener('beforeunload', handleBeforeUnload);

    // 6. Cleanup function (Close window when parent unmounts)
    return () => {
      externalWindow.removeEventListener('beforeunload', handleBeforeUnload);
      externalWindow.close();
    };
  }, []);

  return container ? createPortal(children, container) : null;
}

export default PopoutWindow;
</file>

<file path="dashboard-ui/src/components/ProtectedRoute.jsx">
import { useLocation, Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

function ProtectedRoute({ children, adminOnly = false }) {
  const { user, token, isLoading } = useAuth();
  const location = useLocation();

  if (isLoading) {
    return <div style={{padding: '2rem'}}>Loading authentication...</div>;
  }

  if (!token) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }
  
  if (adminOnly && user?.role !== 'Admin') {
    return <Navigate to="/" replace />; // Not an admin, send to home
  }

  return children;
}
export default ProtectedRoute;
</file>

<file path="dashboard-ui/src/context/SystemStatusContext.jsx">
import { createContext, useState, useContext, useEffect, useRef } from 'react';
import apiClient from '../api';

const SystemStatusContext = createContext(null);

export const SystemStatusProvider = ({ children }) => {
  const [liveData, setLiveData] = useState({ tags: {} });
  
  // FIX: Initialize state from LocalStorage so we remember "Last Seen" after refresh
  const [connectionStatus, setConnectionStatus] = useState(() => {
      const saved = localStorage.getItem('lastSystemSeen');
      return {
          state: 'CONNECTING',
          lastSeen: saved ? new Date(saved) : null
      };
  });

  const isFetchingRef = useRef(false);

  useEffect(() => {
    let isMounted = true;

    const performHeartbeat = async () => {
      if (isFetchingRef.current) return;
      isFetchingRef.current = true;

      try {
        const response = await apiClient.get(`/api/live-data?_=${Date.now()}`, { timeout: 2000 });
        
        if (isMounted) {
            setLiveData(response.data);
            const now = new Date();
            // FIX: Save to LocalStorage
            localStorage.setItem('lastSystemSeen', now.toISOString());
            
            setConnectionStatus({
                state: 'ONLINE',
                lastSeen: now
            });
        }
      } catch (error) {
        if (isMounted) {
            setConnectionStatus(prev => ({
                state: 'OFFLINE',
                lastSeen: prev.lastSeen 
            }));
        }
      } finally {
        isFetchingRef.current = false;
      }
    };

    performHeartbeat();
    const intervalId = setInterval(performHeartbeat, 1000);

    return () => {
        isMounted = false;
        clearInterval(intervalId);
    };
  }, []);

  const value = {
    liveData,
    connectionStatus,
    formatTime: (date) => {
        if (!date) return "Never";
        return new Date(date).toLocaleTimeString('en-US', { hour12: false });
    }
  };

  return (
    <SystemStatusContext.Provider value={value}>
      {children}
    </SystemStatusContext.Provider>
  );
};

export const useSystemStatus = () => useContext(SystemStatusContext);
</file>

<file path="dashboard-ui/src/pages/HomePage.jsx">
import { useState } from 'react';
import { useOutletContext } from "react-router-dom";
import { useSystemStatus } from '../context/SystemStatusContext'; // <--- USE CONTEXT
import CommandsSidebar from '../components/CommandsSidebar';
import FlywheelVisual from '../components/FlywheelVisual';
import HealthStatus from '../components/HealthStatus';
import PopoutWindow from '../components/PopoutWindow'; 

function HomePage() {
  const { setpoints } = useOutletContext();
  
  // Consuming Global State instead of local fetching
  const { liveData, connectionStatus, formatTime } = useSystemStatus();

  // Popout States
  const [isFlywheelPopped, setIsFlywheelPopped] = useState(false);
  const [isDashboardPopped, setIsDashboardPopped] = useState(false);

  // --- DERIVED VALUES ---
  const tags = liveData.tags || {};
  const maxSpeed = 1800;
  const currentSpeed = tags['VFD_Sts_MtrSpeedScaled'] || 0;
  const powerOutput = tags['VFD_Sts_OutPowerScaled'] || 0;
  const dcVolts = tags['VFD_Sts_DCVolts'] || 0;
  const temp1 = tags['TT001.Scaled'];
  const temp2 = tags['TT002.Scaled'];
  const totalEnergy = tags['Test_InfiniteCounter'] || 0;
  const setpointSent = tags['Test_OutputVal1'];
  const setpointReadback = tags['Test_InputVal1'];
  const isTripped = tags['VFD_Sts_Tripped'];
  const hasWarning = tags['VFD_Sts_Warning'];
  const psu1Healthy = tags['PSU001_HLTY'];
  const psu2Healthy = tags['PSU002_HLTY'];
  const flywheelPercentage = (currentSpeed / maxSpeed) * 100;
  
  let flywheelStatus = "Idle";
  if (powerOutput > 0.5) flywheelStatus = "Charging";
  else if (powerOutput < -0.5) flywheelStatus = "Discharging";

  // --- COMPONENT CHUNKS ---

  // 2. The Flywheel Visual Wrapper
  const flywheelVisualContent = (
    <div style={{position: 'relative', width: '100%', height: '100%', display: 'flex', justifyContent: 'center', alignItems: 'center'}}>
        <FlywheelVisual 
            percentage={flywheelPercentage}
            status={flywheelStatus}
        />
        {!isDashboardPopped && (
            <button 
                className="maximize-btn" 
                style={{position: 'absolute', top: 10, right: 10}}
                onClick={() => setIsFlywheelPopped(!isFlywheelPopped)}
            >
                {isFlywheelPopped ? 'Dock' : '❐ Pop Widget'}
            </button>
        )}
    </div>
  );

  // 3. The Full Dashboard Layout
  const dashboardContent = (
    <div className="home-layout" style={{
        height: isDashboardPopped ? '100vh' : 'calc(100vh - 100px)',
        backgroundColor: '#1e1e1e',
        position: 'relative' 
    }}>

      <CommandsSidebar setpoints={setpoints} />
      
      <div className="flywheel-section" style={{position: 'relative', backgroundColor: '#1e1e1e'}}>
        {isFlywheelPopped && !isDashboardPopped ? (
            <>
                <div style={{height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px dashed #444', color: '#666'}}>
                    Flywheel Visual is popped out.
                    <button className="maximize-btn" style={{marginLeft:'10px'}} onClick={() => setIsFlywheelPopped(false)}>Return</button>
                </div>
                <PopoutWindow title="Flywheel Visualization" onClose={() => setIsFlywheelPopped(false)}>
                    <div style={{height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: '#1e1e1e'}}>
                        {flywheelVisualContent}
                    </div>
                </PopoutWindow>
            </>
        ) : (
            flywheelVisualContent
        )}
      </div>

      <div className="sidebar status-sidebar">
        <div className="status-group">
          <h2>Overview</h2>
          <div className="status-item"><span>Flywheel Status</span><span>{flywheelStatus}</span></div>
          <div className="status-item"><span>Power</span><span>{powerOutput.toFixed(2)} kW</span></div>
          <div className="status-item"><span>Speed</span><span>{currentSpeed} RPM</span></div>
          <div className="status-item"><span>DC Voltage</span><span>{dcVolts} V</span></div>
          <div className="status-item"><span>Total Energy</span><span>{(totalEnergy / 1000).toFixed(1)} kWh</span></div>
        </div>
        <div className="status-group">
          <h2>Temperatures</h2>
          <div className="status-item"><span>Bearing 1</span><span>{typeof temp1 === 'number' ? temp1.toFixed(1) + ' °C' : 'N/A'}</span></div>
          <div className="status-item"><span>Bearing 2</span><span>{typeof temp2 === 'number' ? temp2.toFixed(1) + ' °C' : 'N/A'}</span></div>
        </div>
        <div className="status-group">
          <h2>System Health</h2>
          <HealthStatus title="VFD Tripped" value={isTripped} isHealthy={!isTripped} unhealthyText="TRIPPED" />
          <HealthStatus title="VFD Warning" value={hasWarning} isHealthy={!hasWarning} unhealthyText="WARNING" />
          <HealthStatus title="PSU 1" value={psu1Healthy} />
          <HealthStatus title="PSU 2" value={psu2Healthy} />
        </div>
        <div className="status-group">
          <h2>Setpoint Feedback</h2>
          <div className="status-item debug-item">
            <span>Setpoint Sent:</span>
            <span>{typeof setpointSent === 'number' ? setpointSent.toFixed(2) : 'N/A'}</span>
          </div>
          <div className="status-item debug-item" style={{ color: '#00c4ff' }}>
            <span>Setpoint Readback (2x):</span>
            <span>{typeof setpointReadback === 'number' ? setpointReadback.toFixed(2) : 'N/A'}</span>
          </div>
        </div>
      </div>
    </div>
  );

  // --- RENDER RETURN ---

  if (isDashboardPopped) {
      return (
          <>
            <div style={{
                height: 'calc(100vh - 60px)', 
                display: 'flex', 
                flexDirection: 'column',
                alignItems: 'center', 
                justifyContent: 'center', 
                backgroundColor: '#1a1a1a',
                color: '#888'
            }}>
                <div style={{fontSize: '2em', marginBottom: '1rem'}}>Main Dashboard is Popped Out</div>
                <div style={{marginBottom: '2rem'}}>Use the external window to control the system.</div>
                <button 
                    className="maximize-btn" 
                    style={{fontSize: '1.2em', padding: '10px 20px'}}
                    onClick={() => setIsDashboardPopped(false)}
                >
                    Return Dashboard to Main Window
                </button>
            </div>

            <PopoutWindow title="SCADA Main Dashboard" onClose={() => setIsDashboardPopped(false)}>
                {dashboardContent}
            </PopoutWindow>
          </>
      );
  }

  return (
    <div style={{height: '100%', display: 'flex', flexDirection: 'column'}}>
        {/* Header Bar */}
        <div style={{
            padding: '10px 20px', 
            backgroundColor: '#252525', 
            borderBottom: '1px solid #333', 
            display: 'flex', 
            justifyContent: 'flex-end',
            alignItems: 'center',
            gap: '15px'
        }}>
            <div style={{
                display: 'flex', 
                alignItems: 'center', 
                gap: '8px',
                fontSize: '0.9em',
                fontWeight: 'bold',
                color: connectionStatus.state === 'ONLINE' ? '#2ecc71' : '#e74c3c'
            }}>
                <div style={{
                    width: '10px', 
                    height: '10px', 
                    borderRadius: '50%', 
                    backgroundColor: connectionStatus.state === 'ONLINE' ? '#2ecc71' : '#e74c3c',
                    boxShadow: connectionStatus.state === 'ONLINE' ? '0 0 8px #2ecc71' : 'none'
                }}></div>
                {connectionStatus.state === 'ONLINE' 
                    ? 'SYSTEM ONLINE' 
                    : `OFFLINE (Last: ${formatTime(connectionStatus.lastSeen)})`
                }
            </div>

            <button 
                className="maximize-btn" 
                onClick={() => setIsDashboardPopped(true)}
            >
                ❐ Pop Out Dashboard
            </button>
        </div>

        {dashboardContent}
    </div>
  );
}

export default HomePage;
</file>

<file path="dashboard-ui/src/App.css">
/* --- GLOBAL STYLES & DARK THEME --- */
:root {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: #1e1e1e;
  color: #dcdcdc;
}
body { margin: 0; }
.App { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
.main-content { flex-grow: 1; overflow-y: auto; }

/* Custom Scrollbar for Dark Theme */
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-track { background: #2d2d2d; }
::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: #777; }

/* --- HEADER & NAVIGATION --- */
.App-header { display: flex; align-items: center; background-color: #2d2d2d; padding: 0 2rem; height: 60px; border-bottom: 1px solid #444; flex-shrink: 0; }
.logo-container img { height: 40px; }
.navigation { flex-grow: 1; display: flex; justify-content: center; gap: 1rem; }
.navigation a { color: #a0a0a0; text-decoration: none; font-size: 1.1em; padding: 0.5rem 1rem; border-radius: 6px; transition: background-color 0.2s; }
.navigation a.active, .navigation a:hover { color: #ffffff; background-color: #444; }
.header-right-side { display: flex; align-items: center; gap: 1.5rem; margin-left: auto; }
.status-time { color: #a0a0a0; white-space: nowrap; font-variant-numeric: tabular-nums; }
.logout-button { background-color: #3a3a3a; color: #a0a0a0; border: 1px solid #555; border-radius: 6px; padding: 0.5rem 1rem; font-size: 1em; cursor: pointer; transition: all 0.2s; }
.logout-button:hover { background-color: #c0392b; color: white; border-color: #e74c3c; }

/* --- GENERIC COMPONENTS --- */
.sidebar { background-color: #2d2d2d; border-radius: 8px; overflow-y: auto; }
.card { background-color: #2d2d2d; border-radius: 8px; padding: 1.5rem; }

/* --- HOME PAGE --- */
.home-layout { 
  display: grid; 
  grid-template-columns: 300px 1fr 350px; 
  height: calc(100vh - 60px); 
  overflow: hidden; 
}

.commands-sidebar { padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
.commands-sidebar h2 { margin: 0 0 1rem 0; font-size: 1.5em; font-weight: 600; border-bottom: 1px solid #444; padding-bottom: 1rem; }
.commands-sidebar button { width: 100%; padding: 1.2rem; font-size: 1.5em; border-radius: 8px; border: 1px solid #555; background-color: #3a3a3a; color: #dcdcdc; cursor: pointer; transition: background-color 0.2s; }
.commands-sidebar button:hover { background-color: #4a4a4a; }
.commands-sidebar button:disabled { background-color: #2a2a2a; color: #666; cursor: not-allowed; border-color: #444; }

.status-sidebar { padding: 2rem; }
.status-group { margin-bottom: 2rem; }
.status-group h2 { margin: 0 0 1rem 0; font-size: 1.5em; font-weight: 600; border-bottom: 1px solid #444; padding-bottom: 1rem; }
.status-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid #444; font-size: 1.1em; }
.status-item:last-child { border-bottom: none; }
.status-item span:first-child { color: #a0a0a0; }
.status-item span:last-child { font-weight: bold; font-size: 1.1em; font-variant-numeric: tabular-nums; }
.debug-item span:first-child { color: #f0a !important; font-style: italic; }

/* --------------------------------------------------------- */

.health-item { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; margin-bottom: 0.8rem; }
.health-indicator { font-weight: bold; padding: 0.2rem 0.6rem; border-radius: 5px; }
.health-item.healthy .health-indicator { background-color: #27ae60; color: white; }
.health-item.unhealthy .health-indicator { background-color: #c0392b; color: white; }
.health-item.unknown .health-indicator { background-color: #7f8c8d; color: white; }

/* --- OPERATIONAL DETAILS PAGE --- */
.details-layout-final { 
  display: grid; grid-template-columns: 250px 1fr 350px; 
  height: calc(100vh - 60px); 
  gap: 1rem; padding: 1rem; box-sizing: border-box;
}

.charts-container-final { display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto; padding-right: 0.5rem; }
.pens-sidebar { padding: 1rem; }
.pen-group h4 { margin: 0 0 1rem 0; border-bottom: 1px solid #555; padding-bottom: 0.5rem; }
.pen-item { display: flex; align-items: center; margin-bottom: 0.75rem; font-size: 0.9em; }
.pen-color-swatch { width: 15px; height: 15px; margin-right: 0.75rem; border: 1px solid #555; border-radius: 3px; }
.pen-item input { margin-right: 0.5rem; }
.pen-item label { cursor: pointer; user-select: none; }

.chart-card-container { display: grid; grid-template-columns: 220px 1fr; gap: 1rem; background-color: #2d2d2d; padding: 1rem; border-radius: 8px; height: 350px; }
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; height: 40px; }
.chart-header h3 { margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: 0.5rem; }
.live-badge { background-color: #c0392b; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

.individual-time-selector { display: flex; align-items: center; gap: 0.5rem; }
.individual-time-selector select { padding: 0.3rem; border-radius: 4px; background-color: #3a3a3a; color: #dcdcdc; border: 1px solid #555; }
.chart-wrapper { height: calc(100% - 45px); position: relative; width: 100%; }

.sensor-sidebar { padding: 1rem; }
.sensor-list { display: flex; flex-direction: column; gap: 0.8rem; }
.sensor-item { display: flex; justify-content: space-between; align-items: center; font-size: 1em; border-bottom: 1px solid #444; padding-bottom: 0.8rem; }
.sensor-item:last-child { border-bottom: none; }
.sensor-value { font-variant-numeric: tabular-nums; font-family: monospace; font-size: 1.1em; color: #41D1FF; }

/* --- ENGINEERING & LOGIN PAGES --- */
.engineering-layout, .login-container { padding: 2rem; display: flex; justify-content: center; width: 100%; box-sizing: border-box; }
.engineering-layout > div, .login-container form { width: 100%; max-width: 600px; }
.form-group { display: flex; flex-direction: column; margin-bottom: 1.5rem; }
.form-group label { margin-bottom: 0.5rem; color: #a0a0a0; }
.form-group input { padding: 0.8rem; border-radius: 6px; background-color: #1e1e1e; color: #dcdcdc; border: 1px solid #555; font-size: 1.1em; }
.form-group-with-button { display: grid; grid-template-columns: 1fr 120px 80px; gap: 1rem; align-items: center; margin-bottom: 1rem; }
.tag-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
.tag-table th, .tag-table td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #444; }
.tag-table th { background-color: #3a3a3a; }
.status-toggle { border: none; cursor: pointer; padding: 0.5rem 1rem; border-radius: 5px; font-weight: bold; width: 100%; }
.status-toggle.active { background-color: #27ae60; color: white; }
.status-toggle.inactive { background-color: #7f8c8d; color: #ddd; }
.error-message { color: #e74c3c; font-weight: bold; margin-bottom: 1rem; }

/* --- RESPONSIVE MEDIA QUERIES --- */
@media (max-width: 1200px) {
  .home-layout, .details-layout-final {
    grid-template-columns: 1fr; /* Stack vertically */
    height: auto;
    overflow-y: auto;
  }
  .sidebar, .chart-card-container {
    height: auto;
    min-height: 400px;
  }
  .flywheel-container {
    padding: 3rem 0;
  }
  /* On mobile/tablet, stack the specific chart sidebar */
  .chart-card-container {
    grid-template-columns: 1fr;
    grid-template-rows: auto 400px;
  }
  .App-header {
    flex-wrap: wrap;
    height: auto;
    padding: 1rem;
    gap: 1rem;
  }
  .header-right-side {
    margin-left: 0;
    width: 100%;
    justify-content: space-between;
  }
}

/* --- OPERATIONAL DETAILS PAGE LAYOUT --- */
.details-layout-final { 
  display: grid; 
  /* Fixed Width Sidebar | Flexible Charts | Fixed Width Sidebar */
  grid-template-columns: 250px 1fr 300px; 
  height: calc(100vh - 60px); 
  gap: 1rem; 
  padding: 1rem; 
  box-sizing: border-box;
  overflow: hidden; /* Prevent the whole page from scrolling */
}

/* Middle Column: The Scrollable Chart Area */
.charts-container-final { 
  display: flex; 
  flex-direction: column; 
  gap: 1.5rem; 
  overflow-y: auto; /* Only this middle part scrolls */
  padding-right: 0.5rem; 
  min-height: 0; /* Crucial for nested flex scrolling */
}

/* Individual Chart Card */
.chart-card-container { 
  display: flex; 
  flex-direction: column; 
  background-color: #2d2d2d; 
  padding: 1rem; 
  border-radius: 8px; 
  /* Fixed height for each chart card ensures they don't collapse or explode */
  height: 400px; 
  flex-shrink: 0; /* Don't let them shrink smaller than 400px */
}

.chart-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 1rem; 
  height: 40px; 
}

/* The wrapper around the Canvas */
.chart-wrapper { 
  flex-grow: 1; 
  position: relative; 
  width: 100%; 
  min-height: 0; /* CRITICAL FIX: Stops chart from growing infinitely */
}

/* Message styling for Loading / No Data */
.no-data-message, .loading-message {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  color: #666;
  font-style: italic;
}

/* Sidebars */
.sidebar { 
  background-color: #2d2d2d; 
  border-radius: 8px; 
  overflow-y: auto; 
  height: 100%; /* Fill the grid cell */
}

/* Right Sidebar specific */
.sensor-list {
  padding-bottom: 2rem;
}

/* --- SENSOR SIDEBAR IMPROVEMENTS --- */

/* 1. Header with Maximize Button */
.sidebar-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  border-bottom: 1px solid #444;
  padding-bottom: 0.5rem;
}

.sidebar-header-row h2 {
  margin: 0;
  font-size: 1.2em;
}

.maximize-btn {
  background-color: #333;
  color: #a0a0a0;
  border: 1px solid #555;
  padding: 0.3rem 0.6rem;
  font-size: 0.8em;
  border-radius: 4px;
}
.maximize-btn:hover {
  background-color: #41D1FF;
  color: #000;
  border-color: #41D1FF;
}

/* 2. Stacked Items (Label Top, Value Bottom) for readability */
.sensor-item {
  display: flex;
  flex-direction: column; /* Stack vertically */
  align-items: flex-start; /* Align left */
  border-bottom: 1px solid #444;
  padding: 0.8rem 0;
}

.sensor-label {
  font-size: 0.85em;
  color: #888;
  margin-bottom: 0.2rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sensor-value {
  font-size: 1.3em; /* Larger font for value */
  font-family: 'Courier New', monospace; /* Monospace for alignment */
  color: #41D1FF;
  font-weight: 600;
}

/* 3. MAXIMIZED MODE (The "Sensor Wall") */
.sensor-sidebar.maximized {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background-color: #1a1a1a;
  padding: 2rem;
  box-sizing: border-box;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* When maximized, switch list to a Grid */
.sensor-sidebar.maximized .sensor-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Auto-fit grid */
  gap: 1.5rem;
  padding-top: 1rem;
}

.sensor-sidebar.maximized .sensor-item {
  background-color: #2d2d2d;
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid #444;
  border-bottom: 1px solid #444; /* Reset border */
}

.sensor-sidebar.maximized .sensor-label {
  color: #aaa;
}

.sensor-sidebar.maximized .sensor-value {
  font-size: 1.8em; /* Even bigger on big screen */
  margin-top: 0.5rem;
}

/* Scrollbar within sidebar */
.sensor-sidebar::-webkit-scrollbar { width: 6px; }
.sensor-sidebar::-webkit-scrollbar-thumb { background-color: #555; border-radius: 3px; }

/* --- SCADA ALARM OVERLAYS --- */
.connection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.75); /* Dim the background */
  backdrop-filter: blur(3px); /* Blur the dashboard */
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.connection-box {
  background-color: #1a1a1a;
  padding: 2.5rem;
  border-radius: 12px;
  border: 2px solid #e74c3c; /* Red Border */
  text-align: center;
  box-shadow: 0 0 30px rgba(231, 76, 60, 0.3);
  animation: pulse-border 2s infinite;
  max-width: 500px;
}

.connection-box h2 {
  margin: 0 0 1rem 0;
  color: #e74c3c;
  font-size: 2em;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.connection-box p {
  color: #dcdcdc;
  font-size: 1.2em;
  margin-bottom: 1.5rem;
}

.retry-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #333;
  border-top: 4px solid #e74c3c;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes pulse-border {
  0% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
  50% { box-shadow: 0 0 25px rgba(231, 76, 60, 0.6); }
  100% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
}

.flywheel-system-visual-container {
    width: 600px; 
    height: 100%; /* Take full height of parent flex container */
    max-height: 800px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.flywheel-diagram {
    position: relative;
    width: 100%;
    height: 100%;
    display: grid;
    /* 1. Command Labels | 2. Flywheel Stack | 3. Status Labels */
    grid-template-columns: 150px 1fr 150px; 
    grid-template-rows: 1fr;
    align-items: center;
    padding: 20px 0;
}

/* Common style for the tag labels pointing to the graphic */
.tag-label {
    position: absolute;
    color: #f0a; /* Pink color from your diagram */
    font-size: 0.75em;
    font-family: monospace;
    white-space: nowrap;
}

/* --- COMMAND INDICATORS (Left Column) --- */
.command-indicators {
    height: 100%;
    position: relative;
}
.command-indicators .tag-charge { top: 10%; right: 0; }
.command-indicators .tag-discharge { top: 20%; right: 0; }
.command-indicators .tag-shutdown { top: 35%; right: 0; }
.command-indicators .tag-startup { top: 45%; right: 0; }
.command-indicators .active { font-weight: bold; color: #41D1FF; }

/* --- STATUS INDICATORS (Right Column) --- */
.status-indicators {
    height: 100%;
    position: relative;
    /* Positions on the right side of the diagram */
}
.status-indicators .tag-status { top: 10%; left: 0; }
.status-indicators .tag-power { top: 20%; left: 0; }
.status-indicators .tag-energy { top: 30%; left: 0; }
.status-indicators .tag-soc { top: 40%; left: 0; }
.status-indicators .tag-speed { top: 50%; left: 0; }
.status-indicators .tag-energy-total { top: 60%; left: 0; }
.status-indicators .tag-cycles { top: 70%; left: 0; }
.status-indicators .tag-runhours { top: 80%; left: 0; }


/* --- FLYWHEEL STACK (Center Column) --- */
.flywheel-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    padding-top: 50px; /* Space for AC Network box */
    position: relative;
}
.flywheel-section-top {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
}

.ac-network-box {
    border: 2px solid #555;
    padding: 5px 15px;
    background-color: #333;
    color: #fff;
    font-size: 0.9em;
}

.power-flow-arrow {
    font-size: 3em;
    font-weight: bold;
    margin: 5px 0;
    animation: flow-pulse 2s infinite ease-in-out;
}
.flow-charge { color: #2ecc71; }
.flow-discharge { color: #e74c3c; }
.flow-idle { color: #888; }

.power-readout {
    text-align: center;
    margin-top: 5px;
}
.power-value { font-size: 1.5em; font-weight: bold; color: #41D1FF; }
.power-tag-label { color: #f0a; font-size: 0.6em; }

.flywheel-body {
    width: 250px;
    height: 450px;
    background-color: #555;
    border: 5px solid #888;
    border-radius: 10px;
    position: relative;
    display: flex;
    justify-content: space-between;
}

.rotor-fill {
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 80%;
    background: linear-gradient(to right, #444, #333, #444);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
}
.rotor-text { color: #aaa; font-size: 1.1em; font-style: italic; }

.flywheel-base {
    width: 300px;
    height: 50px;
    background-color: #444;
    border-radius: 0 0 5px 5px;
    border-top: 5px solid #888;
}

/* Sensor Zones within the Flywheel Body */
.sensor-zone-left, .sensor-zone-right {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    padding: 10px 0;
    width: 40%; /* To position them near the edges */
}

.sensor-group-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 5px;
    margin: 10px 0;
}
.sensor-group-item .tag-label { position: static; color: #f0a; }

.sensor-zone-left .sensor-group-item { align-items: flex-start; margin-left: -40px; }
.sensor-zone-right .sensor-group-item { align-items: flex-end; margin-right: -40px; }

/* Styles for HealthStatus in the visual (must be minimal) */
.sensor-group-item .health-item {
    font-size: 0.8em;
    padding: 0;
    margin: 0;
}
.sensor-group-item .health-indicator {
    padding: 2px 4px;
    font-size: 0.9em;
}

/* Animations */
@keyframes flow-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Remove old flywheel visual styles to prevent conflict */
.flywheel-visual, .flywheel-text, .flywheel-fill, .spinning-charge, .spinning-discharge {
    display: none; /* Hide the old component styles */
}
</file>

<file path="dashboard-ui/src/App.jsx">
import { useState, useEffect } from 'react';
import { Outlet, NavLink, useNavigate } from "react-router-dom";
import { useAuth } from './context/AuthContext';
import { useSystemStatus } from './context/SystemStatusContext'; // <--- NEW IMPORT
import apiClient from './api';
import './App.css';

function App() {
  const [currentTime, setCurrentTime] = useState(new Date());
  const [isClient, setIsClient] = useState(false);
  const [setpoints, setSetpoints] = useState({});

  const auth = useAuth();
  const { token, logout, user } = auth;
  const navigate = useNavigate();
  
  // Consume System Status for Global Overlay
  const { connectionStatus, formatTime } = useSystemStatus();

  // Redirect Logic
  useEffect(() => {
    if (!isClient) return;
    // Only redirect if NO token. If we have a token but server is down, stay put.
    if (!token && !user) {
      navigate('/login', { replace: true });
    }
  }, [token, user, isClient, navigate]);

  // Fetch Settings (Only if online)
  useEffect(() => {
    const fetchSettings = async () => {
      if (!token) return;
      try {
        const response = await apiClient.get('/api/settings');
        const settingsObj = response.data.reduce((acc, s) => {
          acc[s.key.replace('setpoint_', '')] = s.value;
          return acc;
        }, {});
        setSetpoints(settingsObj);
      } catch (error) {
        // Quiet fail on settings fetch
      }
    };
    if (connectionStatus.state === 'ONLINE') {
        fetchSettings();
    }
  }, [token, connectionStatus.state]);

  useEffect(() => {
    setIsClient(true);
    const timerId = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timerId);
  }, []);

  const formattedTime = currentTime.toLocaleString('en-US', {
    weekday: 'short', month: 'short', day: 'numeric',
    hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false,
  });

  // --- THE GLOBAL OFFLINE OVERLAY ---
  const offlineOverlay = connectionStatus.state === 'OFFLINE' && (
      <div className="connection-overlay">
          <div className="connection-box">
              <h2>Communication Lost</h2>
              <p>
                  Backend server is unreachable.<br/>
                  Last connection: <strong>{formatTime(connectionStatus.lastSeen)}</strong>
              </p>
              <div className="retry-spinner"></div>
              <p style={{fontSize: '0.9em', marginTop: '1rem', color: '#888'}}>
                  System is attempting to reconnect...
              </p>
          </div>
      </div>
  );

  return (
    <div className="App" style={{position: 'relative'}}>
      {/* RENDER OVERLAY ON TOP OF EVERYTHING */}
      {offlineOverlay}

      <header className="App-header">
        <div className="logo-container">
          <img src="/Ohmni_Logo_RGB_Blue_WhiteBG.svg" alt="Ohmni Logo" />
        </div>

        <nav className="navigation">
          <NavLink to="/">Home</NavLink>
          <NavLink to="/operational-details">Operational Details</NavLink>
          <NavLink to="/engineering">Engineering</NavLink>
        </nav>

        <div className="header-right-side">
          <div style={{marginRight: '20px', display: 'flex', alignItems: 'center', gap: '10px'}}>
             <div style={{
                width: '10px', height: '10px', borderRadius: '50%',
                backgroundColor: connectionStatus.state === 'ONLINE' ? '#2ecc71' : '#e74c3c',
                boxShadow: connectionStatus.state === 'ONLINE' ? '0 0 8px #2ecc71' : 'none'
             }}></div>
             <span style={{fontSize: '0.9em', color: '#a0a0a0'}}>
                {connectionStatus.state === 'ONLINE' ? 'ONLINE' : 'OFFLINE'}
             </span>
          </div>
          <div className="status-time">{isClient ? formattedTime : 'Loading...'}</div>
          {token && (
            <button onClick={logout} className="logout-button">Log Out</button>
          )}
        </div>
      </header>

      <main className="main-content">
        <Outlet context={{ setpoints, setSetpoints, user: auth.user }} />
      </main>
    </div>
  );
}

export default App;
</file>

<file path="dashboard-ui/src/index.css">
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}

.command-feedback {
  margin-top: 1rem;
  border-top: 2px solid #535bf2;
  font-weight: bold;
}
</file>

<file path="dashboard-ui/.gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="dashboard-ui/eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="dashboard-ui/index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/ohmni_pty_ltd_logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dashboard-ui</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="dashboard-ui/package.json">
{
  "name": "dashboard-ui",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "chart.js": "^4.5.1",
    "chartjs-adapter-date-fns": "^3.0.0",
    "date-fns": "^4.1.0",
    "react": "^19.2.0",
    "react-chartjs-2": "^5.3.1",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.9.6"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.2",
    "@types/react-dom": "^19.2.2",
    "@vitejs/plugin-react": "^5.1.0",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "vite": "^7.2.2"
  }
}
</file>

<file path="dashboard-ui/README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="dashboard-ui/vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path="Dockerfile.backend">
# Dockerfile.backend

# Use a specific Python image built for ARM architecture
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# 1. Install System Build Dependencies (gcc, libpq-dev, python headers)
# We keep these separate to ensure we clean them up later if needed, 
# but for now, they are needed during pip install.
# 1. Install System Build Dependencies (CRITICAL FIX: Adding ping/net tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    make \
    libpq-dev \
    python3-dev \
    libffi-dev \
    # --- ADDED NETWORK DIAGNOSTICS ---
    iputils-ping \
    net-tools \
    # -----------------------------------
    && rm -rf /var/lib/apt/lists/*

# 2. Copy requirements and install Python packages (including psycopg2)
COPY requirements.txt .
# This step is where psycopg2-binary and others are compiled and installed
RUN pip install --no-cache-dir -r requirements.txt

# 3. Clean up the build tools (OPTIONAL: saves space, but may cause issues if needed later)
# Since the image is slim, we'll skip removing gcc/g++ to avoid complication, 
# but a production image would ideally remove them.

# 4. Copy application files
COPY main_api.py .
COPY .env .

# Expose FastAPI port
EXPOSE 8000

# Command to run the application
CMD ["python", "main_api.py"]
</file>

<file path="Dockerfile.frontend">
# Dockerfile.frontend
# 1 - build react app
FROM node:20-alpine AS builder
WORKDIR /app
COPY dashboard-ui/package.json dashboard-ui/package-lock.json ./
RUN npm install
COPY dashboard-ui/ .
RUN npm run build

# 2 - serve static files with nginx
FROM nginx:alpine AS runner
RUN rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
</file>

<file path="hash_password.py">
from passlib.context import CryptContext
import sys

# This must match the context in your main_api.py
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# Use a default password or get one from the command line
plain_password = "password"
if len(sys.argv) > 1:
    plain_password = sys.argv[1]

hashed_password = pwd_context.hash(plain_password)

print("\n--- PASSWORD HASH GENERATED ---")
print(f"Plain text: '{plain_password}'")
print("\nCOPY THE SQL COMMAND BELOW and run it in your psql terminal:")
print("-" * 50)
print(f"UPDATE app.users SET hashed_password = '{hashed_password}' WHERE username = 'admin';")
print("-" * 50)
</file>

<file path="nginx.conf">
server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /token {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
    }
}
</file>

<file path="test_db_insert.py">
import psycopg2
from dotenv import load_dotenv
import os
import time

# --- CONFIGURATION ---
load_dotenv()
DB_CONFIG = {
    "host": os.getenv("DB_HOST", "localhost"),
    "port": os.getenv("DB_PORT", "5432"),
    "dbname": os.getenv("DB_NAME"),
    "user": os.getenv("DB_USER"),
    "password": os.getenv("DB_PASSWORD")
}

# --- TEST PARAMETERS ---
# From our psql test, we know tag_id 23 is for 'VFD_Sts_OutPowerScaled' (a float)
TEST_TAG_ID = 23
TEST_FLOAT_VALUE = 99.99
CURRENT_TIMESTAMP = time.strftime('%Y-%m-%d %H:%M:%S %Z')

print("--- Python Database Insert Test ---")
conn = None
try:
    print("Connecting to database...")
    conn = psycopg2.connect(**DB_CONFIG)
    print("Connection successful.")
    
    with conn.cursor() as cur:
        # We will use the STRICT syntax that worked for you in psql
        sql_query = "INSERT INTO historian.historian (tag_id, value_float, ts) VALUES (%s, %s, %s)"
        params = (TEST_TAG_ID, TEST_FLOAT_VALUE, CURRENT_TIMESTAMP)
        
        # This special line asks psycopg2 to show us the EXACT query it will run
        print("\nPython is attempting to execute this SQL:")
        print(cur.mogrify(sql_query, params).decode('utf-8'))
        
        # Now, execute the command
        cur.execute(sql_query, params)
        conn.commit()
        
        print("\n✅ SUCCESS: The INSERT command worked from Python!")

except Exception as e:
    print(f"\n🔴 FAILED: The script crashed with an error.")
    print(f"   Error: {e}")
    if conn:
        conn.rollback()
finally:
    if conn:
        conn.close()
        print("\nConnection closed.")

print("--- Test Complete ---")
</file>

<file path="test_db_read.py">
# test_db_read.py (CREATE THIS FILE on your host)
import psycopg2
import os
from dotenv import load_dotenv

load_dotenv()
DB_CONFIG = {
    "host": os.getenv("DB_HOST"), "port": os.getenv("DB_PORT", "5432"),
    "dbname": os.getenv("DB_NAME"), "user": os.getenv("DB_USER"),
    "password": os.getenv("DB_PASSWORD")
}

try:
    conn = psycopg2.connect(**DB_CONFIG)
    cur = conn.cursor()
    cur.execute("SELECT role FROM app.users WHERE username = 'admin'")
    print(f"Role read from DB: {cur.fetchone()}")
except Exception as e:
    print(f"Error: {e}")
finally:
    if conn: conn.close()
</file>

<file path="dashboard-ui/src/components/CommandsSidebar.jsx">
import apiClient from '../api';
import { useAuth } from '../context/AuthContext'; // Import the auth hook to check token

const COMMAND_TAG_BASE = 'A25_SIM_';

// FIX 1: Change parameter name from 'value' to 'commandKey'
function CommandsSidebar({ setpoints }) {
  const { token } = useAuth(); // Get the current token status

  const handleSetpointCommand = async (commandKey) => { // <-- FIXED PARAM NAME
    // SECURITY FIX: If there is no token, prevent the command from running immediately.
    if (!token) {
        alert("Action Restricted: Please log in to send control commands.");
        return;
    }
    
    // FIX 2: Construct tagName and get setpoint value based on commandKey
    const tagName = COMMAND_TAG_BASE + commandKey.charAt(0).toUpperCase() + commandKey.slice(1);
    const setpointValue = setpoints[commandKey]; // <-- Use a different variable name to avoid confusion
    
    // FIX 3: Parse the setpointValue
    const numericValue = parseFloat(setpointValue); 
    
    if (isNaN(numericValue)) {
      alert(`Setpoint value for ${commandKey} is not a valid number.`);
      return;
    }

    try {
      await apiClient.post('/api/write-tag', { 
        tag_name: tagName, // <-- Use tagName here
        value: numericValue // <-- Use numericValue here
      });
      alert(`Simulation Command sent: Set ${tagName} to ${numericValue}`);
    } catch (error) {
      console.error(`Error writing to ${tagName}:`, error);
      alert(`Failed to send command. Server may require re-login. Check WRITEABLE_TAGS list in backend.`);
    }
  };

  // The component is DISABLED if setpoints haven't loaded OR if the user is logged out
  const isDisabled = !setpoints || Object.keys(setpoints).length === 0 || !token;

  return (
    <div className="sidebar commands-sidebar">
      <h2>Commands (SIM)</h2>
      <button onClick={() => handleSetpointCommand('charge')} disabled={isDisabled}>Charge</button>
      <button onClick={() => handleSetpointCommand('discharge')} disabled={isDisabled}>Discharge</button>
      <button onClick={() => handleSetpointCommand('shutdown')} disabled={isDisabled}>Shutdown</button>
      {/* FIX: Use 'startup' key for the 'Set Idle' button command */}
      <button onClick={() => handleSetpointCommand('startup')} disabled={isDisabled}>Set Idle</button> 
    </div>
  );
}

export default CommandsSidebar;
</file>

<file path="dashboard-ui/src/components/StreamingChart.jsx">
import { useState, useEffect, useRef, useMemo } from "react";
import { Line } from "react-chartjs-2";
import { 
    Chart as ChartJS, 
    CategoryScale, 
    LinearScale, 
    PointElement, 
    LineElement, 
    Title, 
    Tooltip, 
    Legend, 
    TimeScale,
    Decimation 
} from "chart.js";
import 'chartjs-adapter-date-fns';
import apiClient from '../api';
import { subSeconds } from 'date-fns';

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend, TimeScale, Decimation);

function StreamingChart({ selectedTags, displayRangeSec, tagColorMap }) {
  const rawDataRef = useRef({});
  const [chartData, setChartData] = useState({ datasets: [] });
  const [isLoading, setIsLoading] = useState(true);
  const pollingRef = useRef(null);
  
  const pollInterval = 1000; // 10Hz

  // --- DUAL MODE CONFIGURATION ---
  // "Safe Mode" (<= 5 mins): Standard rendering. Reliable.
  // "Performance Mode" (> 5 mins): Decimation ON, Parsing OFF. Fast.
  const isPerformanceMode = displayRangeSec > 300; 

  const chartOptions = useMemo(() => {
    // BASE OPTIONS
    const opts = {
        responsive: true, 
        maintainAspectRatio: false, 
        animation: false, 
        spanGaps: false,
        plugins: { 
            legend: { display: false },
            decimation: { enabled: false } // Default disabled
        },
        scales: {
            x: {
                type: "time",
                time: { unit: "second", tooltipFormat: "HH:mm:ss.SSS" },
                ticks: { color: '#a0a0a0', maxRotation: 0, autoSkip: true, maxTicksLimit: 10, source: 'auto' },
                grid: { color: '#333' }
            },
            y: { ticks: { color: '#a0a0a0' }, grid: { color: '#333' } },
        },
        elements: {
            line: { tension: 0, borderWidth: 2 },
            point: { radius: 0, hoverRadius: 5 } // Default hidden
        }
    };

    if (isPerformanceMode) {
        // --- PERFORMANCE MODE (> 5 mins) ---
        opts.parsing = false; // Trust our x: ms data
        opts.normalized = true;
        opts.plugins.decimation = {
            enabled: true,
            algorithm: 'min-max',
            samples: 500, 
        };
    } else {
        // --- SAFE MODE (<= 5 mins) ---
        opts.parsing = true; // Let Chart.js parse the ISO strings/Date objs
        // Show dots only if range is very short (1 min or less)
        if (displayRangeSec <= 120) {
            opts.elements.point.radius = 2;
        }
    }

    return opts;
  }, [isPerformanceMode, displayRangeSec]);

  const mergeAndSetData = (incomingData, endTime, windowSeconds) => {
    const newRawData = { ...rawDataRef.current };

    selectedTags.forEach((tag) => {
      if (!newRawData[tag]) newRawData[tag] = [];
      const existingTimestamps = new Set(newRawData[tag].map((p) => p.ts));
      
      if (incomingData[tag] && Array.isArray(incomingData[tag])) {
          incomingData[tag].forEach((newPoint) => {
            if (existingTimestamps.has(newPoint.ts)) return;
            // Basic validation
            if (newPoint.value === null || newPoint.value === undefined) return;
            const numericValue = parseFloat(newPoint.value);
            if (isNaN(numericValue)) return;

            newRawData[tag].push({ ts: newPoint.ts, value: numericValue });
          });
      }
      
      // Prune old
      const cutoff = subSeconds(endTime, windowSeconds).getTime();
      newRawData[tag] = newRawData[tag].filter(
        (p) => new Date(p.ts).getTime() >= cutoff
      );
      
      newRawData[tag].sort((a, b) => new Date(a.ts).getTime() - new Date(b.ts).getTime());
    });

    rawDataRef.current = newRawData;

    const datasets = selectedTags.map((tag) => {
        const rawPoints = rawDataRef.current[tag] || [];
        
        // DATA TRANSFORMATION BASED ON MODE
        let dataPoints;
        if (isPerformanceMode) {
            // Performance Mode: Needs {x: Milliseconds, y: Value}
            dataPoints = rawPoints.map(p => ({ x: new Date(p.ts).getTime(), y: p.value }));
        } else {
            // Safe Mode: Needs {x: ISO String, y: Value} (Standard parsing)
            dataPoints = rawPoints.map(p => ({ x: p.ts, y: p.value }));
        }

        return {
            label: tag,
            data: dataPoints,
            borderColor: tagColorMap[tag],
            backgroundColor: tagColorMap[tag] + '80',
        };
    });

    setChartData({ datasets });
  };

  useEffect(() => {
    rawDataRef.current = {};
    if (pollingRef.current) clearTimeout(pollingRef.current);
    setIsLoading(true);

    let isMounted = true;

    const runProcess = async () => {
      const now = new Date();
      
      // 1. Initial Backfill
      try {
        const start = subSeconds(now, displayRangeSec);
        const params = new URLSearchParams();
        selectedTags.forEach(tag => params.append('tags', tag));
        params.append('start_time', start.toISOString());
        params.append('end_time', now.toISOString());

        const histResponse = await apiClient.get('/api/historian', { params });
        if (isMounted) {
            mergeAndSetData(histResponse.data, now, displayRangeSec);
            setIsLoading(false); 
        }
      } catch (e) {
        if (isMounted) setIsLoading(false);
      }

      // 2. Polling Loop
      const poll = async () => {
        if (!isMounted) return;
        const loopNow = new Date();
        const loopStart = subSeconds(loopNow, 10); // Fetch last 10 seconds to avoid gaps 

        try {
          const params = new URLSearchParams();
          selectedTags.forEach(tag => params.append('tags', tag));
          params.append('start_time', loopStart.toISOString());
          params.append('end_time', loopNow.toISOString());

          const liveResponse = await apiClient.get('/api/historian', { params });
          if (isMounted) {
            mergeAndSetData(liveResponse.data, loopNow, displayRangeSec);
          }
        } catch (e) { }
        pollingRef.current = setTimeout(poll, pollInterval);
      };

      poll();
    };

    runProcess();

    return () => {
      isMounted = false;
      if (pollingRef.current) clearTimeout(pollingRef.current);
    };
  }, [selectedTags, displayRangeSec]); 

  if (isLoading) {
    return (
        <div style={{
            height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', 
            color: '#a0a0a0', flexDirection: 'column', gap: '10px'
        }}>
            <span>Loading Data...</span>
        </div>
    );
  }

  // Key forces full re-mount when switching between Safe/Performance modes
  return (
    <Line 
        key={isPerformanceMode ? 'perf' : 'safe'} 
        data={chartData} 
        options={chartOptions} 
    />
  );
};

export default StreamingChart;
</file>

<file path="dashboard-ui/src/constants/index.js">
// src/constants/index.js

export const COLORS = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];

export const chartDefinitions = [
    { 
        title: "Power", // Based on Picture 2 Top
        tags: [
            'A25_Power', 
            'A25_Speed', 
            'A25_Energy', // Mapped to 'Energy' in diagram
        ] 
    },
    { 
        title: "Vibration", // Based on Picture 2 Middle
        tags: [
            'VT001.Scaled', 
            'VT002.Scaled',
            'A25_Speed',
        ] 
    },
    { 
        title: "Temperature", 
        tags: [
            'A25_Speed',
            'VT001.Scaled',
            'VT002.Scaled',
        ] 
    },
    { 
        title: "Electromag", // Based on Picture 3 Top (Simplified)
        tags: [
            'A25_Speed',
            'EM_SV',
            'Wt001.Scaled',
        ] 
    },
    { 
        title: "Pressure", // Based on Picture 3 Middle (Simplified)
        tags: [
            'PT001_Scaled'
        ] 
    },
    {
        title: "Custom", // Based on Picture 3 Bottom (Simplified / Custom)
        tags: [
            'A25_SoC',
            'A25_Cycles',
            'A25_RunHours',
            'Test_InfiniteCounter' // Moved from Home page
        ]
    }
];

// All tags from all definitions
export const allPossibleTags = [...new Set(chartDefinitions.flatMap(c => c.tags))];

// The map is created once and exported for global use
export const tagColorMap = Object.fromEntries(
    allPossibleTags.map((tag, index) => [tag, COLORS[index % COLORS.length]])
);
</file>

<file path="dashboard-ui/src/pages/LoginPage.jsx">
// File: dashboard-ui/src/pages/LoginPage.jsx

import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate, useLocation } from 'react-router-dom';

function LoginPage() {
  // FIX: Start with empty state for clean fields and better security UX
  const [username, setUsername] = useState(''); 
  const [password, setPassword] = useState(''); 
  const [error, setError] = useState('');
  const auth = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  
  const from = location.state?.from?.pathname || "/";

  const handleSubmit = async (e) => {
    e.preventDefault(); 
    setError(''); 
    
    // Attempt login using current state values
    const success = await auth.login(username, password);

    if (success) {
      navigate(from, { replace: true });
    } else {
      // FIX 2: Do NOT clear username or password state here.
      // The current values in the state (username, password) will be retained
      // in the input fields because they are bound via `value={...}`.
      setError('Invalid username or password.'); 
    }
  };

  return (
    <div className="login-container">
      <form onSubmit={handleSubmit} className="card">
        <h2>Login Required</h2>
        <p>You must log in to view this page.</p>
        {error && <p className="error-message">{error}</p>} 
        <div className="form-group">
          <label htmlFor="username">Username</label>
          <input type="text" id="username" value={username} onChange={e => setUsername(e.target.value)} required />
        </div>
        <div className="form-group">
          <label htmlFor="password">Password</label>
          <input type="password" id="password" value={password} onChange={e => setPassword(e.target.value)} required />
        </div>
        <button type="submit">Log In</button>
      </form>
    </div>
  );
}
export default LoginPage;
</file>

<file path="dashboard-ui/src/pages/SensorWallPage.jsx">
import { useState, useEffect } from 'react';
import apiClient from '../api';

function SensorWallPage() {
  const [liveTags, setLiveTags] = useState({});
  const [status, setStatus] = useState('connecting');

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await apiClient.get('/api/live-data');
        setLiveTags(response.data.tags || {});
        setStatus('connected');
      } catch (error) {
        console.error("Error fetching live data:", error);
        setStatus('disconnected');
      }
    };

    fetchData();
    const intervalId = setInterval(fetchData, 250); 
    return () => clearInterval(intervalId);
  }, []);

  const sortedTags = Object.entries(liveTags).sort((a, b) => a[0].localeCompare(b[0])); 

  return (
    <div style={{
      backgroundColor: '#1a1a1a', 
      minHeight: '100vh', 
      width: '100vw', // CRITICAL FIX: Force full viewport width
      padding: '20px', 
      color: '#dcdcdc',
      display: 'flex',
      flexDirection: 'column',
      boxSizing: 'border-box',
      overflowX: 'hidden' // Prevent horizontal scrollbar
    }}>
      {/* Header Section */}
      <div style={{
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        borderBottom: '2px solid #444', 
        paddingBottom: '1rem',
        marginBottom: '1.5rem',
        width: '100%'
      }}>
        <h1 style={{margin: 0, fontSize: '2em', color: 'white'}}>All Live Tag Values</h1>
        
        <div style={{textAlign: 'right'}}>
            <div style={{
                color: status === 'connected' ? '#2ecc71' : '#e74c3c', 
                fontWeight: 'bold', 
                fontSize: '1.2em',
                marginBottom: '5px'
            }}>
                {status === 'connected' ? '● LIVE' : '○ DISCONNECTED'}
            </div>
            <div style={{fontSize: '0.9em', color: '#888'}}>
                {sortedTags.length} Data Points
            </div>
        </div>
      </div>

      {/* THE TILE GRID */}
      <div style={{
        display: 'grid',
        // 'auto-fill' will cram as many 220px blocks as possible into the width
        gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))',
        gap: '15px',
        width: '100%',
        boxSizing: 'border-box'
      }}>
        {sortedTags.map(([tagName, value]) => (
          <div key={tagName} style={{
            backgroundColor: '#2d2d2d',
            padding: '1.2rem',
            borderRadius: '8px',
            border: '1px solid #444',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'space-between',
            height: '110px', 
            position: 'relative',
            overflow: 'hidden'
          }}>
            {/* Tag Name */}
            <span style={{
              color: '#bbb', 
              fontSize: '0.85em', 
              fontWeight: '500',
              marginBottom: '0.5rem',
              wordWrap: 'break-word',
              lineHeight: '1.2',
              maxHeight: '2.4em',
              overflow: 'hidden'
            }} title={tagName}>
              {tagName}
            </span>

            {/* Tag Value */}
            <span style={{
              color: '#41D1FF', 
              fontSize: '1.8em', 
              fontFamily: 'monospace', 
              fontWeight: 'bold',
              alignSelf: 'flex-end',
              textAlign: 'right',
              width: '100%',
              whiteSpace: 'nowrap',
              overflow: 'hidden',
              textOverflow: 'ellipsis'
            }}>
              {typeof value === 'number' ? value.toFixed(2) : String(value)}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
}

export default SensorWallPage;
</file>

<file path="dashboard-ui/src/main.jsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import { createBrowserRouter, RouterProvider } from "react-router-dom";
import App from './App.jsx';
import './index.css';
import { AuthProvider } from './context/AuthContext';
import { SystemStatusProvider } from './context/SystemStatusContext'; // <--- NEW IMPORT
import HomePage from './pages/HomePage';
import OperationalDetailsPage from './pages/OperationalDetailsPage';
import EngineeringPage from './pages/EngineeringPage';
import LoginPage from './pages/LoginPage';
import SensorWallPage from './pages/SensorWallPage';
import ProtectedRoute from './components/ProtectedRoute';

const router = createBrowserRouter([
  {
    path: "/",
    element: <App />,
    children: [
      { index: true, element: <HomePage /> },
      { path: "operational-details", element: <OperationalDetailsPage /> },
      { 
        path: "engineering", 
        element: (
          <ProtectedRoute>
            <EngineeringPage />
          </ProtectedRoute>
        )
      },
      { path: "login", element: <LoginPage /> },
    ],
  },
  {
    path: "/sensor-wall",
    element: <SensorWallPage />
  }
]);

ReactDOM.createRoot(document.getElementById('root')).render(
    <SystemStatusProvider> 
      <AuthProvider> 
        <RouterProvider router={router} />
      </AuthProvider>
    </SystemStatusProvider>
)
</file>

<file path=".gitignore">
venv/
__pycache__/

.env
repomix-output.xml
node_modules/
dist/
dashboarrd-ui/node_modules/
dashboard-ui/dist/
</file>

<file path="docker-compose.yml">
version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: a25scada_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - API_KEY=${API_KEY}
      - PLC_IP=${PLC_IP}
      # Set DB_HOST to the actual remote Tailscale IP (set in .env)
      - DB_HOST=${DB_HOST} 
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    dns:
      - 8.8.8.8  # <--- MUST ADD THIS
      - 8.8.4.4
    # DELETE the depends_on block entirely. The backend is now fully independent.
    
  # --- 2. REACT FRONTEND (Nginx) ---
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: a25scada_frontend
    restart: unless-stopped
    ports:
      - "80:80" 
    depends_on:
      - backend
    dns:
      - 8.8.8.8  # <--- MUST ADD THIS
      - 8.8.4.4

# DELETE THE VOLUMES SECTION ENTIRELY
# volumes:
#   postgres_data:
</file>

<file path="requirements.txt">
annotated-doc==0.0.4
annotated-types==0.7.0
anyio==4.11.0
certifi==2025.11.12
click==8.3.0
colorama==0.4.6
dnspython==2.8.0
email-validator==2.3.0
exceptiongroup==1.3.0
fastapi==0.121.2
fastapi-cli==0.0.16
fastapi-cloud-cli==0.3.1
h11==0.16.0
httpcore==1.0.9
httptools==0.7.1
httpx==0.28.1
idna==3.11
itsdangerous==2.2.0
Jinja2==3.1.6
lxml==6.0.2
markdown-it-py==4.0.0
MarkupSafe==3.0.3
mdurl==0.1.2
opcua==0.98.13
orjson==3.11.4
pydantic==2.12.4
pydantic-extra-types==2.10.6
pydantic-settings==2.12.0
pydantic_core==2.41.5
Pygments==2.19.2
python-dateutil==2.9.0.post0
python-dotenv==1.2.1
python-jose[cryptography]
passlib[bcrypt]==1.7.4
py-bcrypt
pylogix
psycopg2-binary===2.9.9
python-multipart==0.0.20
pytz==2025.2
PyYAML==6.0.3
rich==14.2.0
rich-toolkit==0.15.1
rignore==0.7.6
sentry-sdk==2.44.0
shellingham==1.5.4
six==1.17.0
sniffio==1.3.1
starlette==0.49.3
tomli==2.3.0
typer==0.20.0
typing-inspection==0.4.2
typing_extensions==4.15.0
ujson==5.11.0
urllib3==2.5.0
uvicorn==0.38.0
watchfiles==1.1.1
websockets==15.0.1
</file>

<file path="dashboard-ui/src/context/AuthContext.jsx">
// File: dashboard-ui/src/context/AuthContext.jsx

import { createContext, useState, useContext, useEffect } from 'react';
import apiClient from '../api';
import { useSystemStatus } from './SystemStatusContext'; 

// Minimal JWT Payload Decoder (since we avoid extra dependencies)
function decodeJwtPayload(token) {
    if (!token) return null;
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (e) {
        console.error("Failed to decode JWT payload:", e);
        return null;
    }
}

const AuthContext = createContext(null);

// Non-hook way to access the logout function for the global interceptor in api.js
let globalLogout = () => {};

export const AuthProvider = ({ children }) => {
  const initialToken = localStorage.getItem('authToken');
  const [token, setToken] = useState(initialToken);

  // Synchronous User Initialisation from jwt payload.
  const [user, setUser] = useState(() => {
    const initialToken = localStorage.getItem('authToken');
    const payload = decodeJwtPayload(initialToken);
    return (payload && payload.sub && payload) ? 
    { username : payload.sub, role: payload.role} : null;
  });

  // Load only if there is a token to validate over the network
  const [isLoading, setIsLoading] = useState(
    initialToken && (!user || !user.role) ? true : false
  );
  
  const { connectionStatus } = useSystemStatus(); 

  const fetchUser = async (currentToken) => {

      if (!currenToken || connectionStatus.state === 'OFFLINE') {
        setIsLoading(false);
        return null;
      }

      try {
        apiClient.defaults.headers.common['Authorization'] = `Bearer ${currentToken}`;
        const userResponse = await apiClient.get('/users/me', { timeout: 2000 }); 
        setUser(userResponse.data);
        return userResponse.data; // Return user data on success
      } catch (error) {
        if (error.response && error.response.status === 401) {
            logout();
        } 
        return null; 
      } finally {
        setIsLoading(false); 
      }
  };

  useEffect(() => {
    // Initial load: if token exists, run network validation to confirm it's still active.
    if (token && (isLoading || connectionStatus.state === 'ONLINE')) {
      fetchUser(token);
    } else if (!token) {
      setIsLoading(false);
    }
    // Note: Do NOT add 'user' to the dependency array. That creates an infinite loop.
  }, [token, connectionStatus.state]);

    const login = async (username, password) => {
    setIsLoading(true); 
    try {
      const params = new URLSearchParams();
      params.append('username', username);
      params.append('password', password);
      const response = await apiClient.post('/token', params);
      const { access_token } = response.data;
      
      setToken(access_token);
      localStorage.setItem('authToken', access_token);
      
      // === FIX: SHORT-CIRCUIT ASYNC /users/me CALL FOR INITIAL ROLE POPULATION ===
      const payload = decodeJwtPayload(access_token);
      
      if (payload && payload.sub && payload.role) {
          // Synchronously set the user state based on the token payload
          const initialUser = { username: payload.sub, role: payload.role };
          setUser(initialUser); 
          setIsLoading(false); // Auth is complete and role is set
          return true;
      }

      // Fallback: If JWT parsing failed, force a network call (last resort)
      console.warn("JWT payload incomplete, falling back to /users/me check...");
      const fetchedUser = await fetchUser(access_token);
      return !!fetchedUser;

    } catch (error) {
      console.error("Login failed:", error);
      setIsLoading(false); 
      return false;
    }
  };
  
  const logout = () => {
    setToken(null);
    setUser(null);
    localStorage.removeItem('authToken');
    delete apiClient.defaults.headers.common['Authorization'];
    setIsLoading(false); // Reset loading state when logging out
    window.location.href = '/login'; // Force a full page reload after clearing state to ensure all components reset.
  };

  useEffect(() => {
    globalLogout = logout;
  }, []);

  const value = { token, user, login, logout, isLoading };

  return (
    <AuthContext.Provider value={value}>
    {/* Show loading screen only if actively validating a token */}
      {isLoading && token ? (
          <div style={{
              height: '100vh', display: 'flex', alignItems: 'center', 
              justifyContent: 'center', backgroundColor: '#1e1e1e', color: '#888'
          }}>
              Verifying Session...
          </div>
      ) : (
          children
      )}
    </AuthContext.Provider>
  );
};

export const useAuth = () => useContext(AuthContext);

export const setGlobalLogout = (logoutFn) => {
  globalLogout = logoutFn;
};
export const getGlobalLogout = () => globalLogout;
</file>

<file path="dashboard-ui/src/pages/EngineeringPage.jsx">
import { useState, useEffect } from 'react';
import { useOutletContext } from "react-router-dom";
import apiClient from '../api';
import { useAuth } from '../context/AuthContext'; // Keep useAuth for robust role check

function SetpointManager() {
    // FIX: Revert to using useOutletContext internally, as originally designed,
    // to keep it simple and avoid passing props when not strictly necessary.
    const { setpoints, setSetpoints } = useOutletContext();
    const [localSettings, setLocalSettings] = useState(setpoints); 

    // Sync local state when global setpoints load, but only if user isn't actively editing
    useEffect(() => { 
        if (setpoints) setLocalSettings(setpoints); 
    }, [setpoints]);

    if (!setpoints || Object.keys(setpoints).length === 0) return <div className="card"><h2>Loading Setpoints...</h2></div>;

    const handleInputChange = (key, value) => {
        setLocalSettings(prev => ({ ...prev, [key]: value }));
    };

    const handleSave = async (key) => {
        const rawValue = localSettings[key];
        const numValue = rawValue === '' ? 0 : parseFloat(rawValue);
        
        try {
            await apiClient.put(`/api/settings/setpoint_${key}`, { key: `setpoint_${key}`, value: numValue });
            setSetpoints(prev => ({ ...prev, [key]: numValue }));
            setLocalSettings(prev => ({ ...prev, [key]: numValue }));
            alert(`Setting '${key}' saved successfully!`);
        } catch (err) { 
            alert('Failed to update setting.'); 
            console.error("Failed to save setting:", err);
        }
    };
    
    const getValue = (val) => (val === undefined || val === null) ? '' : val;

    return (
        <div className="card">
            <h2>Command Setpoints (Engineer)</h2>
            <p>Configure the value sent to the PLC for each command.</p>
            {['charge', 'discharge', 'shutdown', 'idle'].map((key) => (
                <div className="form-group-with-button" key={key}>
                    <label>{key.charAt(0).toUpperCase() + key.slice(1)} Value:</label>
                    <input 
                        type="number" 
                        value={getValue(localSettings[key])} 
                        onChange={(e) => handleInputChange(key, e.target.value)} 
                    />
                    <button onClick={() => handleSave(key)}>Save</button>
                </div>
            ))}
        </div>
    );
}

// === RESTORING THE MISSING TAG MANAGER COMPONENT ===
function TagManager() {
    const [tags, setTags] = useState([]);
    const [isFetching, setIsFetching] = useState(true);
    const [isError, setIsError] = useState(false); 

    useEffect(() => {
        const fetchTags = async () => {
            setIsFetching(true);
            setIsError(false);
            try {
                const response = await apiClient.get('/api/tags');
                setTags(response.data);
                setIsError(false);
            } catch (err) { 
                console.error('Failed to fetch tags for TagManager:', err.response?.status, err.message); 
                setIsError(true); 
            } finally {
                setIsFetching(false);
            }
        };
        fetchTags();
    }, []);

    if (isFetching) {
        return (
            <div className="card" style={{marginTop: '2rem'}}>
                <h2>Tag Polling Configuration (Admin)</h2>
                <p>Loading configuration...</p>
            </div>
        );
    }
    
    if (isError) {
        return (
            <div className="card" style={{marginTop: '2rem', borderLeft: '5px solid #e74c3c'}}>
                <h2>Tag Polling Configuration (Admin)</h2>
                <p style={{color: '#e74c3c'}}>
                    Configuration data inaccessible. (Check console for error).
                </p>
            </div>
        );
    }

    return (
        <div className="card" style={{marginTop: '2rem'}}>
            <h2>Tag Polling Configuration (Admin)</h2>
            <table className="tag-table">
                <thead><tr><th>ID</th><th>Tag Name</th><th>Data Type</th><th>Status</th></tr></thead>
                <tbody>
                    {tags.map(tag => (
                        <tr key={tag.id}>
                            <td>{tag.id}</td><td>{tag.tag}</td><td>{tag.datatype}</td>
                            <td><button className={`status-toggle ${tag.is_active ? 'active' : 'inactive'}`} onClick={() => handleToggle(tag.id, tag.is_active)}>{tag.is_active ? 'ACTIVE' : 'INACTIVE'}</button></td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}
// === END TAG MANAGER RESTORATION ===

function EngineeringPage() {
    // We rely on useAuth() now, as the sync-login fix ensures it holds the most accurate, non-null user data.
    const { user } = useAuth(); 
    
    // Check if the primary data structure (user object) has resolved.
    if (!user) {
        // This state handles the brief moment after login but before the context has propagated.
        return (
            <div className="engineering-layout">
                <div className="card" style={{width: '100%', maxWidth: '600px'}}>
                    <h2>Authenticating Role...</h2>
                    <p>Please wait while the final permissions are verified.</p>
                </div>
            </div>
        );
    }
    
    // Robust role evaluation based on data guaranteed by the AuthContext user
    const role = user.role;
    const isEngineer = role === 'Engineer' || role === 'Admin';
    const isAdmin = role === 'Admin';

    return (
        <div className="engineering-layout">
            <div>
                {/* 1. Show SetpointManager if Engineer or Admin */}
                {isEngineer && <SetpointManager />}
                
                {/* 2. Show TagManager if Admin */}
                {isAdmin && <TagManager />}
                
                {/* 3. Access Denied if authenticated but role is neither */}
                {(!isEngineer && !isAdmin) && (
                    <div className="card">
                        <h2>Access Denied</h2>
                        <p>Your current role ({role}) does not have permission to view this page.</p>
                    </div>
                )}
            </div>
        </div>
    );
}
export default EngineeringPage;
</file>

<file path="dashboard-ui/src/pages/OperationalDetailsPage.jsx">
import { useState, useEffect, useCallback } from 'react';
import { Line } from 'react-chartjs-2';
import { 
    Chart as ChartJS, 
    CategoryScale, 
    LinearScale, 
    PointElement, 
    LineElement, 
    Title, 
    Tooltip, 
    Legend, 
    TimeScale 
} from 'chart.js';
import 'chartjs-adapter-date-fns';
import { subSeconds, subHours, subDays, subMonths, startOfYear } from 'date-fns';

import PensSidebar from '../components/PensSidebar';
import StreamingChart from '../components/StreamingChart';
import PopoutWindow from '../components/PopoutWindow'; // <--- NEW IMPORT
import { chartDefinitions, tagColorMap } from '../constants';
import apiClient from '../api'; 

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, TimeScale);

const staticChartOptions = {
    responsive: true, 
    maintainAspectRatio: false, 
    parsing: false, 
    normalized: true,
    plugins: { 
        legend: { display: true, position: 'top', labels: { color: '#a0a0a0' } } 
    },
    scales: {
        x: { 
            type: 'time', 
            time: { tooltipFormat: 'PP pp' }, 
            ticks: { color: '#a0a0a0', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }, 
            grid: { color: '#333' } 
        },
        y: { 
            ticks: { color: '#a0a0a0' }, 
            grid: { color: '#333' } 
        }
    },
    animation: { duration: 0 }
};

const getDurationInSeconds = (timeRangeKey) => {
    const value = parseInt(timeRangeKey.slice(0, -1));
    const unit = timeRangeKey.slice(-1);
    if (unit === 's') return value;
    if (unit === 'm') return value * 60;
    return 0; 
};

const getStartEndTime = (timeRangeKey) => {
    const now = new Date();
    let startTime = null;

    if (timeRangeKey === '1h') startTime = subHours(now, 1);
    else if (timeRangeKey === '24h') startTime = subHours(now, 24);
    else if (timeRangeKey === '7d') startTime = subDays(now, 7);
    else if (timeRangeKey === '1mo') startTime = subMonths(now, 1);
    else if (timeRangeKey === 'YTD') startTime = startOfYear(now);
    else if (timeRangeKey === 'All') startTime = subDays(now, 365 * 5); // Go back 5 years 

    return { startTime, endTime: now };
};

// --- UPDATED: LiveSensorTable with Pop-out Logic ---
const TELEMETRY_TAGS_TO_DISPLAY = [
    { label: "Power", tag: "A25_Power", unit: "kW" },
    { label: "Speed", tag: "A25_Speed", unit: "RPM" },
    { label: "Flywheel Status", tag: "A25_Status", unit: "Status" }, // Handled specially
    { label: "Upper Bearing Temp.", tag: "TT001.Scaled", unit: "°C" },
    { label: "Lower Bearing Temp.", tag: "TT002.Scaled", unit: "°C" },
    { label: "Motor Temp.", tag: "TT003.Scaled", unit: "°C" },
    { label: "Upper Vibration", tag: "VT001.Scaled", unit: "" },
    { label: "Lower Vibration", tag: "VT002.Scaled", unit: "" },
    { label: "Load Cell", tag: "WT001_Scaled", unit: "kg" },
    { label: "Pressure", tag: "PT001_Scaled", unit: "" },
    { label: "Load Cell Target", tag: "EM_SV", unit: "kg" },
    // Add boolean examples from Picture 3 for demo
    { label: "Vib Health (U)", tag: "VT001_Healthy", unit: "Bool" },
    { label: "Pressure Health", tag: "PT001_Healthy", unit: "Bool" },
];

const getFlywheelStatusText = (statusCode) => {
    switch(statusCode) {
        case 2: return 'Charging';
        case 3: return 'Discharging';
        case 1: return 'Idle';
        case 0: return 'Shutdown';
        case 4: return 'Fault';
        default: return 'Unknown';
    }
}

function LiveSensorTable({ tags }) {
    
    const handlePopout = () => {
        // Calculate center of screen
        const width = 1000;
        const height = 800;
        const left = (window.screen.width / 2) - (width / 2);
        const top = (window.screen.height / 2) - (height / 2);
        
        // Open the dedicated route in a new window
        window.open(
            '/sensor-wall', 
            'SensorWallWindow', 
            `width=${width},height=${height},left=${left},top=${top},resizable,scrollbars`
        );
    };

    if (!tags || Object.keys(tags).length === 0) return <div className="sidebar sensor-sidebar">Loading...</div>;

    return (
        <div className="sidebar sensor-sidebar">
            <div className="sidebar-header-row">
                <h2>Telemetry</h2> {/* <--- Updated Title */}
                <button 
                    className="maximize-btn" 
                    onClick={handlePopout}
                >
                    ❐ Pop Out Wall
                </button>
            </div>
            
            <div className="sensor-list">
                {TELEMETRY_TAGS_TO_DISPLAY.map(({ label, tag, unit }) => {
                    const value = tags[tag];
                    let displayValue;
                    
                    if (tag === "A25_Status") {
                        displayValue = getFlywheelStatusText(value);
                    } else if (typeof value === 'number') {
                        // All numeric values display to 2 decimal places (or just the number)
                        displayValue = `${value.toFixed(value % 1 !== 0 ? 2 : 0)} ${unit}`;
                    } else if (typeof value === 'boolean' || unit === 'Bool') {
                         displayValue = value ? 'TRUE' : 'FALSE';
                    } else {
                        displayValue = String(value);
                    }
                    
                    return (
                        <div className="sensor-item" key={tag}>
                            <span className="sensor-label">{label}</span>
                            <span className="sensor-value">
                                {displayValue}
                            </span>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

const IndividualTimeSelector = ({ onSelect }) => {
    const ranges = {
        '1m': '1 Minute (Live)',
        '5m': '5 Minutes (Live)',
        '30m':'30 Minutes (Live)',
        '1h': '1 Hour (History)',
        '24h': '24 Hours (History)',
        '7d': '7 Days (History)',
        '1mo': '1 Month (History)',
        'YTD': 'Year to Date',
        'All': 'All Time'
    };

    return (
        <div className="individual-time-selector">
            <span>Range:</span>
            <select onChange={(e) => onSelect(e.target.value)} defaultValue="5m">
                {Object.entries(ranges).map(([key, label]) => (
                    <option key={key} value={key}>{label}</option>
                ))}
            </select>
        </div>
    );
};

// --- UPDATED: HistorianChart with Pop-out Logic ---
function HistorianChart({ title, visibleTags, fetchHistoricalData }) {
    const [timeRange, setTimeRange] = useState('5m'); 
    const [staticData, setStaticData] = useState({ datasets: [] });
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);
    const [isPoppedOut, setIsPoppedOut] = useState(false);

    const isStreamingMode = ['1m', '5m', '30m'].includes(timeRange);

    useEffect(() => {
        if (isStreamingMode || visibleTags.length === 0) return;

        const loadHistory = async () => {
            setIsLoadingHistory(true);
            const data = await fetchHistoricalData(title, visibleTags, timeRange);
            setStaticData(data);
            setIsLoadingHistory(false);
        };

        loadHistory();
    }, [timeRange, visibleTags, isStreamingMode, title, fetchHistoricalData]);

    // The Inner Content
    const chartContent = (
        <div className="chart-card" style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
            <div className="chart-header">
                <h3>
                    {title} 
                    {isStreamingMode ? 
                        <span className="live-badge" style={{marginLeft:'10px'}}>LIVE</span> : 
                        <span style={{marginLeft:'10px', fontSize:'0.7em', color:'#a0a0a0'}}>HISTORICAL</span>
                    }
                </h3>
                <div style={{display:'flex', gap:'10px'}}>
                    <IndividualTimeSelector onSelect={setTimeRange} />
                    <button className="maximize-btn" onClick={() => setIsPoppedOut(!isPoppedOut)}>
                        {isPoppedOut ? 'Dock' : '❐ Pop'}
                    </button>
                </div>
            </div>

            <div className="chart-wrapper" style={{flexGrow: 1, minHeight: 0}}>
                {visibleTags.length === 0 ? (
                    <div className="no-data-message">No Pens Selected</div>
                ) : isStreamingMode ? (
                    <StreamingChart 
                        selectedTags={visibleTags}
                        displayRangeSec={getDurationInSeconds(timeRange)}
                        tagColorMap={tagColorMap}
                    />
                ) : (
                    isLoadingHistory ? (
                        <div className="loading-message">Loading History...</div>
                    ) : (
                        <Line
                            key={visibleTags.join('-')}
                            options={staticChartOptions}
                            data={staticData}></Line>
                    )
                )}
            </div>
        </div>
    );

    if (isPoppedOut) {
        return (
            <>
                <div className="chart-card-container placeholder" style={{height: '100px', display:'flex', alignItems:'center', justifyContent:'center'}}>
                    <span style={{color: '#666', fontStyle: 'italic'}}>{title} is open in another window.</span>
                    <button className="maximize-btn" style={{marginLeft: '10px'}} onClick={() => setIsPoppedOut(false)}>Bring Back</button>
                </div>
                <PopoutWindow title={title} onClose={() => setIsPoppedOut(false)}>
                    <div style={{height: '100vh', padding: '1rem', boxSizing: 'border-box', backgroundColor: '#2d2d2d'}}>
                        {chartContent}
                    </div>
                </PopoutWindow>
            </>
        );
    }

    return (
        <div className="chart-card-container">
            {chartContent}
        </div>
    );
}

function OperationalDetailsPage() {
    const [liveTags, setLiveTags] = useState({});
    const [visiblePens, setVisiblePens] = useState(() => {
        const initial = {};
        chartDefinitions.forEach(def => {
            initial[def.title] = def.tags; 
        });
        return initial;
    });
    const [historicalCache, setHistoricalCache] = useState({});
    const fetchHistoricalData = useCallback(async (chartTitle, visibleTags, timeRange) => {
        // Create unique key for the cache entry
        const cacheKey = `${chartTitle}-${timeRange}-${visibleTags.join(',')}`;
        
        // 1. Check Cache
        if (historicalCache[cacheKey]) {
            return historicalCache[cacheKey];
        }
        
        // 2. Fetch from API
        try {
            const { startTime, endTime } = getStartEndTime(timeRange);
            const params = new URLSearchParams();
            visibleTags.forEach(tag => params.append('tags', tag));
            if (startTime) params.append('start_time', startTime.toISOString());
            params.append('end_time', endTime.toISOString());

            const response = await apiClient.get('/api/historian', { params });
            const data = response.data;
            
            // Convert data into chart datasets (same logic as before)
            const newDatasets = visibleTags.map(tagName => ({
                label: tagName,
                data: data[tagName]?.map(p => ({ x: new Date(p.ts).getTime(), y: p.value })) || [],
                borderColor: tagColorMap[tagName] || '#888',
                backgroundColor: (tagColorMap[tagName] || '#888') + '80',
                tension: 0.2, 
                pointRadius: 0, 
                borderWidth: 2,
            }));
            const chartData = { datasets: newDatasets };

            // 3. Update Cache
            setHistoricalCache(prev => ({ ...prev, [cacheKey]: chartData }));
            return chartData;

        } catch (error) {
            console.error(`History fetch failed for ${chartTitle}:`, error);
            return { datasets: [] };
        }
    }, [historicalCache, setHistoricalCache]);

    useEffect(() => {
        const fetchLive = async () => {
            try {
                const resp = await apiClient.get('/api/live-data');
                setLiveTags(resp.data.tags || {});
            } catch (err) { 
                console.error("Live data error:", err); 
            }
        };
        fetchLive(); 
        const intervalId = setInterval(fetchLive, 1000); 
        return () => clearInterval(intervalId);
    }, []);

    const handleTogglePen = (chartTitle, penName) => {
        setVisiblePens(prev => {
            const currentList = prev[chartTitle] || [];
            if (currentList.includes(penName)) {
                return { ...prev, [chartTitle]: currentList.filter(p => p !== penName) };
            } else {
                return { ...prev, [chartTitle]: [...currentList, penName] };
            }
        });
    };

    return (
        <div className="details-layout-final">
            <PensSidebar 
                chartDefinitions={chartDefinitions} 
                visiblePens={visiblePens} 
                onTogglePen={handleTogglePen} 
            />
            <div className="charts-container-final">
                {chartDefinitions.map(chart => (
                    <HistorianChart 
                        key={chart.title}
                        title={chart.title} 
                        visibleTags={visiblePens[chart.title] || []}
                        fetchHistoricalData={fetchHistoricalData}
                    />
                ))}
            </div>
            <LiveSensorTable tags={liveTags} />
        </div>
    );
}

export default OperationalDetailsPage;
</file>

<file path="dashboard-ui/src/api.js">
// src/api.js
import axios from 'axios';

// Set BASE_API_URL to the root path ('/') so Nginx handles proxying to http://backend:8000
import { setGlobalLogoutt, getGlobalLogout } from './context/AuthContext';

export const BASE_API_URL = '/'; 
const API_KEY = import.meta.env.VITE_API_KEY;

const apiClient = axios.create({
  baseURL: BASE_API_URL,
  timeout: 30000, // CRITICAL: Fail requests after 5 seconds if server hangs
});

apiClient.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('authToken');
    if (token) config.headers['Authorization'] = `Bearer ${token}`;
    if (API_KEY) config.headers['x-api-key'] = API_KEY;
    return config;
  },
  (error) => Promise.reject(error)
);

apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response && error.response.status === 401) {
      const isLoginAttempt = error.config.url.endsWith('/token');

      if (!isLoginAttempt) {
        console.log("Global Interceptor: Token expired/invalid. Clearing session.");
        // 1. Clear the bad token immediately
        localStorage.removeItem('authToken');
        delete apiClient.defaults.headers.common['Authorisation'];

        // 2. Redirect to login page to reset the app state
        // This will prevent 'unknown role" error on EnggPage
        window.locaiton.href = '/login';

        // Reject the promise to stop subsequent .then() chains
        return Promise.reject(error);
      }
    }
    return Promise.reject(error);
  }
)

export default apiClient;
</file>

<file path="main_api.py">
import os
import threading
import time
import psycopg2
from psycopg2 import pool
import uvicorn
import queue
from fastapi import FastAPI, Query, Header, HTTPException, Depends, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
from opcua import Server
from pylogix import PLC
from dotenv import load_dotenv
from pydantic import BaseModel
from typing import Union, List, Optional
from datetime import datetime, timezone, timedelta
from contextlib import asynccontextmanager
from jose import JWTError, jwt
from passlib.context import CryptContext

# --- SECURITY SETUP ---
load_dotenv()
SECRET_KEY = os.getenv("SECRET_KEY", "dev_fallback_key")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

# --- CONFIGURATION ---
PLC_IP = os.getenv("PLC_IP")
OPCUA_ENDPOINT = "opc.tcp://0.0.0.0:4840"
OPCUA_SERVER_NAME = "Flywheel_OPCUA_Gateway"
DB_CONFIG = {
    "host": os.getenv("DB_HOST"),
    "port": int(os.getenv("DB_PORT", 5432)),
    "dbname": os.getenv("DB_NAME"),
    "user": os.getenv("DB_USER"),
    "password": os.getenv("DB_PASSWORD"),
}
API_KEY = os.getenv("API_KEY")

WRITEABLE_TAGS = {
    "A25_SIM_Charge", 
    "A25_SIM_Discharge", 
    "A25_SIM_Shutdown", 
    "A25_SIM_Startup",
    "A25_CMD_Charge", 
    "A25_CMD_Discharge", 
    "A25_CMD_Shutdown", 
    "A25_CMD_Startup",
    "EM_SV"
}


TAGS_TO_READ = []
live_data = {"status": "initializing", "tags": {}}
live_data_lock = threading.Lock()
tag_map = {}
opc_tag_nodes = {}
stop_event = threading.Event()
historian_queue = queue.Queue(maxsize=100000) 

# --- DB CONNECTION POOL ---
pg_pool = None

pg_pool = None

def init_db_pool():
    global pg_pool
    print(f"🔵 DB: Attempting connection to {DB_CONFIG['host']}...")
    
    # RETRY LOGIC: Keep trying until connected or manually stopped
    while not stop_event.is_set():
        try:
            pg_pool = pool.ThreadedConnectionPool(minconn=1, maxconn=20, **DB_CONFIG)
            if pg_pool:
                print("✅ DB: Connection pool established.")
                return # Success!
        except Exception as e:
            print(f"🟡 DB Connection Failed: {e}")
            print("⏳ Retrying in 2 seconds...")
            time.sleep(2)

def get_db_conn():
    if not pg_pool: 
        # If pool is missing (e.g. still starting), throw 503 Service Unavailable
        # This tells the frontend "I'm alive, but busy" instead of crashing
        raise HTTPException(status_code=503, detail="Database initializing...")
    return pg_pool.getconn()

def release_db_conn(conn):
    if pg_pool and conn: pg_pool.putconn(conn)

# --- MODELS ---
class Token(BaseModel):
    access_token: str
    token_type: str

class User(BaseModel):
    username: str
    role: str

class Tag(BaseModel):
    id: int
    tag: str
    datatype: str
    is_active: bool

class TagUpdate(BaseModel):
    is_active: bool

class TagWriteRequest(BaseModel):
    tag_name: str
    value: Union[float, int, bool]

class Setting(BaseModel):
    key: str
    value: Union[float, str]

# --- HELPERS ---
def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    expire = datetime.now(timezone.utc) + (expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

def get_user_from_db(username: str):
    conn = None
    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            cur.execute("SELECT username, hashed_password, role, is_active FROM app.users WHERE username = %s", (username,))
            user_data = cur.fetchone()
            if user_data:
                return {"username": user_data[0], "hashed_password": user_data[1], "role": user_data[2], "is_active": user_data[3]}
    except Exception as e:
        print(f"🔴 DB Error (get_user): {e}")
    finally:
        release_db_conn(conn)
    return None

def get_current_user(token: str = Depends(oauth2_scheme)):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        role: str = payload.get("role")  # Get role from JWT
        if not username or not role: raise HTTPException(401, "Invalid token payload")
    except JWTError: raise HTTPException(401, "Invalid token")
    
    # Check if user is active using the database
    user_db = get_user_from_db(username) 
    if not user_db or not user_db["is_active"]: raise HTTPException(401, "User inactive")

    # === REMOVE DEBUG FIX: Rely on actual data (either JWT or user_db role if JWT missing) ===
    # The JWT created in login is: {"sub": user['username'], "role": user['role']}
    # We trust the JWT role, otherwise use the database role as fallback.
    
    # If the JWT contains the role (which it should), use it.
    # We must ensure we return the Pydantic model here using the determined role.
    final_role = payload.get("role") or user_db["role"]
    print(f"!!! DEBUG ROLE RESOLVED: {final_role} !!!") # <--- ADD THIS LOG
    return User(username=username, role=final_role) 

def get_current_active_admin(current_user: User = Depends(get_current_user)):
    if current_user.role != "Admin": raise HTTPException(403, "Admin required")
    return current_user

def get_current_active_engineer(current_user: User = Depends(get_current_user)):
    if current_user.role not in ["Engineer", "Admin"]: raise HTTPException(403, "Engineer required")
    return current_user

def require_api_key(x_api_key: str = Header(None)):
    if not API_KEY or x_api_key != API_KEY: raise HTTPException(401, "Invalid API Key")

# --- THREADS ---
PLC_SOURCE_IP = os.getenv("PLC_SOURCE_IP", None)


def plc_polling_task():
    print("🚀 PLC Poller thread started.")
    comm = None
    
    try:
        while not stop_event.is_set():
            
            if comm is None:
                # --- INITIAL CONNECTION/RECONNECTION ATTEMPT ---
                try:
                    print(f"🔌 Attempting PLC connection to {PLC_IP}...")
                    
                    comm = PLC()
                    comm.IPAddress = PLC_IP
                    # Check if tags are loaded before attempting test read (prevents crash if DB is slow)
                    if not TAGS_TO_READ:
                        print("⏳ Waiting for initial DB tag sync...")
                        time.sleep(1)
                        continue

                    # Diagnostic Test Read
                    test_tag = TAGS_TO_READ[0]["name"]
                    test_result = comm.Read(test_tag)
                    
                    status_check = getattr(test_result, "Status", "Error")
                    if status_check != "Success":
                        comm.Close()
                        comm = None 
                        raise Exception(f"Diagnostic Read Failed: Status={status_check}")
                    
                    print(f"✅ PLC Connection successful.")
                    
                except Exception as e:
                    print(f"🔴 PLC Connection Failed (Initialization): {e}")
                    # Ensure comm is cleaned up
                    if comm:
                        try: comm.Close()
                        except: pass
                    comm = None
                    with live_data_lock: live_data["status"] = "disconnected"
                    time.sleep(5)
                    continue 

            # --- READ LOOP ---
            try:
                tag_names_to_read = [tag["name"] for tag in TAGS_TO_READ]
                if not tag_names_to_read:
                    with live_data_lock: live_data["status"] = "no_tags_configured"
                    time.sleep(1)
                    continue

                results = comm.Read(tag_names_to_read)
                timestamp = datetime.now(timezone.utc)
                # ... (live data processing and historian_queue write unchanged) ...
                
                with live_data_lock:
                    live_data["status"] = "connected"
                    temp_tags = {}
                    iterable_results = results if isinstance(results, list) else [results]
                    
                    for res in iterable_results:
                        tagname = getattr(res, "TagName", None)
                        status = getattr(res, "Status", "Success")
                        val = res.Value if status == 'Success' else f"Error: {status}"
                        temp_tags[tagname] = val
                        
                        if status == 'Success' and isinstance(val, (int, float, bool)):
                            try:
                                historian_queue.put_nowait({"tag": tagname, "value": val, "ts": timestamp})
                            except queue.Full: pass

                    live_data["tags"] = temp_tags

                time.sleep(1)
                
            except Exception as e:
                # Handle read failures by closing and retrying connection
                print(f"🔴 PLC Read Error/Timeout. Reconnecting: {e}")
                with live_data_lock: live_data["status"] = "disconnected"
                
                if comm:
                    try: comm.Close()
                    except: pass
                comm = None 
                time.sleep(5) 
    
    finally:
        if comm:
            try: comm.Close() 
            except: pass
        print("⚪️ PLC Poller thread stopped.")

def opcua_updater_task():
    print("🚀 OPC-UA Updater started.")
    while not stop_event.is_set():
        with live_data_lock: snap = live_data.get("tags", {}).copy()
        for k,v in snap.items():
            if k in opc_tag_nodes and not isinstance(v, str):
                try: opc_tag_nodes[k].set_value(v)
                except: pass
        time.sleep(0.5)

def historian_ingester_task():
    print("🚀 Historian Ingester started.")
    batch_counter = 0
    warned_tags = set() 
    
    while not stop_event.is_set():
        time.sleep(2)
        if historian_queue.empty() or not tag_map: continue
        
        batch = []
        while not historian_queue.empty() and len(batch) < 500:
            batch.append(historian_queue.get())
        if not batch: continue

        conn = None
        count = 0
        # Map Tag Name -> Datatype string
        name_map = {t["name"]: t["datatype"].lower() for t in TAGS_TO_READ}
        
        try:
            conn = get_db_conn()
            with conn.cursor() as cur:
                for item in batch:
                    tn = item['tag']
                    
                    # 1. Check if tag exists in map
                    if tn not in tag_map:
                        if tn not in warned_tags:
                            print(f"⚠️ Ingest Warning: Tag '{tn}' found in PLC but not in DB tag_lookup.")
                            warned_tags.add(tn)
                        continue

                    tid = tag_map[tn]
                    raw_dtype = name_map.get(tn, 'float')
                    val = item['value']
                    ts = item['ts']

                    # --- FIX: Force scaled/analog tags to FLOAT column (Structural Data Integrity) ---
                    is_analog = any(
                        s in tn.lower() for s in ['.scaled', '_rescaled', 'outpowerscaled', 'mtrspeedscaled']
                    )
                    
                    # 2. Map DB datatype string to SQL Table
                    sql = None
                    # If it's explicitly float/real OR if it's a scaled/analog tag, save as float
                    if raw_dtype in ['float', 'real'] or is_analog:
                        sql = "INSERT INTO historian.historian (tag_id, value_float, ts) VALUES (%s, %s, %s)"
                        params = (tid, float(val), ts)
                    elif raw_dtype in ['int', 'integer', 'dint', 'sint']:
                        sql = "INSERT INTO historian.historian (tag_id, value_int, ts) VALUES (%s, %s, %s)"
                        params = (tid, int(val), ts)
                    elif raw_dtype in ['bool', 'boolean', 'bit']:
                        sql = "INSERT INTO historian.historian (tag_id, value_bool, ts) VALUES (%s, %s, %s)"
                        params = (tid, bool(val), ts)
                    
                    if sql:
                        try:
                            cur.execute(sql, params)
                            count += 1
                        except Exception as e:
                            print(f"🔴 SQL Insert Error for {tn}: {e}")
                    else:
                        if tn not in warned_tags:
                            print(f"⚠️ Ingest Warning: Unknown datatype '{raw_dtype}' for tag '{tn}'. Skipping.")
                            warned_tags.add(tn)
                
                conn.commit()
                
                batch_counter += 1
                if batch_counter >= 10:
                    print(f"✅ Historian: Ingested {count} records. Q-Size: {historian_queue.qsize()}")
                    batch_counter = 0
        except Exception as e:
            print(f"🔴 Historian Batch Level Error: {e}")
        finally:
            release_db_conn(conn)

def sync_tags_with_db():
    global tag_map, TAGS_TO_READ
    print("🔵 Syncing tags...")
    conn = None
    
    # FIX: Temporarily hardcode the tags we want to read if DB connection fails 
    # This list must be updated manually in your historian.tag_lookup table later!
    NEW_TAG_LIST = [
        {"name": "A25_CMD_Charge", "datatype": "bool"},
        {"name": "A25_CMD_Discharge", "datatype": "bool"},
        {"name": "A25_CMD_Shutdown", "datatype": "bool"},
        {"name": "A25_CMD_Startup", "datatype": "bool"},
        {"name": "A25_Cycles", "datatype": "int"},
        {"name": "A25_En_Charge", "datatype": "bool"},
        {"name": "A25_En_Dsicharge", "datatype": "bool"},
        {"name": "A25_En_Shutdown", "datatype": "bool"},
        {"name": "A25_Energy", "datatype": "float"},
        {"name": "A25_Energy_Total", "datatype": "float"},
        {"name": "A25_power", "datatype": "float"},
        {"name": "A25_RunHours", "datatype": "int"},
        {"name": "A25_SIM_Charge", "datatype": "bool"},
        {"name": "A25_SIM_Discharge", "datatype": "bool"},
        {"name": "A25_SIM_Shutdown", "datatype": "bool"},
        {"name": "A25_SIM_Startup", "datatype": "bool"},
        {"name": "A25_SoC", "datatype": "float"},
        {"name": "A25_Speed", "datatype": "float"},
        {"name": "A25_Power", "datatype": "float"},
        {"name": "A25_Energy", "datatype": "float"},
        {"name": "VT001.Scaled", "datatype": "float"},
        {"name": "VT002.Scaled", "datatype": "float"},
        {"name": "TT001.Scaled", "datatype": "float"},
        {"name": "TT002.Scaled", "datatype": "float"},
        {"name": "TT003.Scaled", "datatype": "float"},
        {"name": "A25_Status", "datatype": "int"},
        {"name": "WT001_Scaled", "datatype": "float"},
        {"name": "PT001_Scaled", "datatype": "float"},
        {"name": "EM_SV", "datatype": "float"},
        {"name": "PT001_Healthy", "datatype": "bool"},
        {"name": "WT001_Healthy", "datatype": "bool"},
        {"name": "VT001_Healthy", "datatype": "bool"},
        {"name": "VT002_Healthy", "datatype": "bool"},
        {"name": "TT001_Healthy", "datatype": "bool"},
        {"name": "TT002_Healthy", "datatype": "bool"},
        {"name": "TT003_Healthy", "datatype": "bool"},
    ]


    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            cur.execute("SELECT id, tag, datatype, is_active FROM historian.tag_lookup")
            rows = cur.fetchall()
            tag_map = {row[1]: row[0] for row in rows}
            TAGS_TO_READ = [{"name": row[1], "datatype": row[2]} for row in rows if row[3]]
            print(f"✅ Active Tags: {len(TAGS_TO_READ)} from DB")
            
            # CRITICAL FIX: IF NO TAGS CAME FROM DB, FORCE THE NEW LIST
            if not TAGS_TO_READ:
                print("⚠️ DB tag sync failed or returned no active tags. Forcing use of new hardcoded list.")
                # We are forcing the PLC poller to read these names, but they won't be saved to DB historian
                TAGS_TO_READ = [t for t in NEW_TAG_LIST] 
                # Also ensure tag_map is populated so the live-data endpoint has the ID later for saving
                # NOTE: This only works if you manually update the DB's tag_lookup with these tags and IDs later
                # For now, we only care that the PLC Poller reads the names
                tag_map = {t['name']: 9999 for t in TAGS_TO_READ} # Use a dummy ID for now

    except Exception as e:
        print(f"🔴 Tag Sync Failed: {e}. Forcing use of new hardcoded list.")
        TAGS_TO_READ = [t for t in NEW_TAG_LIST] 
        tag_map = {t['name']: 9999 for t in TAGS_TO_READ}
    finally:
        release_db_conn(conn)
        print(f"✅ Poller will attempt to read {len(TAGS_TO_READ)} tags.")

# --- LIFESPAN ---
@asynccontextmanager
async def lifespan(app: FastAPI):
    # 1. Start threads first so API is responsive immediately
    # (The DB retry loop will happen in main thread or we should spawn it?)
    # actually, blocking startup for DB is safer for integrity, 
    # but let's allow it to retry a few times then fail, OR run it in a thread.
    
    # Better approach for Robustness: Run DB init in a background thread 
    # so the API comes up immediately (responding to Health Checks) 
    # even if DB is down.
    
    db_thread = threading.Thread(target=init_db_pool, daemon=True)
    db_thread.start()
    
    # 2. OPC UA Setup
    s = Server()
    s.set_endpoint(OPCUA_ENDPOINT)
    s.set_server_name(OPCUA_SERVER_NAME)
    idx = s.register_namespace("Flywheel")
    obj = s.get_objects_node()
    pf = obj.add_object(idx, "PLC_Tags")
    # Note: opc_tag_nodes will be populated once DB connects and Sync runs
    
    ts = [
        threading.Thread(target=plc_polling_task, daemon=True),
        threading.Thread(target=s.start, daemon=True),
        threading.Thread(target=opcua_updater_task, daemon=True),
        threading.Thread(target=historian_ingester_task, daemon=True)
    ]
    for t in ts: t.start()
    
    # Periodically check if DB is ready to sync tags
    # (Simple sync loop inside lifespan won't work well, 
    # let's add a "Maintenance Thread" that syncs tags once DB is up)
    def maintenance_task():
        tags_loaded = False
        while not stop_event.is_set():
            if pg_pool and not tags_loaded:
                sync_tags_with_db()
                # Create nodes now that we have tags
                global opc_tag_nodes
                for t in TAGS_TO_READ:
                    try:
                        n = pf.add_variable(idx, t["name"], 0)
                        n.set_writable()
                        opc_tag_nodes[t["name"]] = n
                    except: pass
                tags_loaded = True
            time.sleep(1)
            
    threading.Thread(target=maintenance_task, daemon=True).start()
    
    print("🚀 SYSTEM READY. Listening on 0.0.0.0:8000")
    yield
    print("🛑 SHUTDOWN.")
    stop_event.set()
    try: s.stop()
    except: pass
    if pg_pool: pg_pool.closeall()

app = FastAPI(lifespan=lifespan)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.middleware("http")
async def log_requests(request: Request, call_next):
    if request.method == "POST":
        print(f"🔹 {request.method} {request.url.path} from {request.client.host}")
    return await call_next(request)

# --- ENDPOINTS ---
@app.get("/")
def health_check(): return {"status": "online", "ts": datetime.now().isoformat()}

@app.post("/token", response_model=Token)
def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user = get_user_from_db(form_data.username)
    if not user or not verify_password(form_data.password, user['hashed_password']):
        raise HTTPException(401, "Invalid credentials")

    token = create_access_token(data={"sub": user['username'], "role": user['role']})
    return {"access_token": token, "token_type": "bearer"}

@app.get("/users/me", response_model=User) # <-- Ensure this line remains response_model=User
def read_users_me(current_user: User = Depends(get_current_user)):
    # REVERTED to standard return
    return current_user

@app.get("/api/tags", response_model=List[Tag])
def get_tags(user: User = Depends(get_current_active_admin)):
    conn = None
    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            cur.execute("SELECT id, tag, datatype, is_active FROM historian.tag_lookup ORDER BY id")
            return [Tag(id=r[0], tag=r[1], datatype=r[2], is_active=r[3]) for r in cur.fetchall()]
    finally:
        release_db_conn(conn)

@app.put("/api/tags/{tag_id}", response_model=Tag)
def update_tag(tag_id: int, u: TagUpdate, user: User = Depends(get_current_active_admin)):
    conn = None
    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            cur.execute("UPDATE historian.tag_lookup SET is_active = %s WHERE id = %s RETURNING id, tag, datatype, is_active", (u.is_active, tag_id))
            res = cur.fetchone()
            conn.commit()
            if res:
                sync_tags_with_db()
                return Tag(id=res[0], tag=res[1], datatype=res[2], is_active=res[3])
            raise HTTPException(404, "Tag not found")
    finally:
        release_db_conn(conn)

@app.get("/api/historian")
def get_historian(tags: List[str] = Query(None), start_time: Optional[str] = None, end_time: Optional[str] = None):
    
    if not tags: return {}
    st = start_time or "1970-01-01T00:00:00Z"
    et = end_time or datetime.utcnow().isoformat()
    
    dur = 9999999
    try:
        st_obj = datetime.fromisoformat(st.replace('Z', '+00:00'))
        et_obj = datetime.fromisoformat(et.replace('Z', '+00:00'))
        dur = (et_obj - st_obj).total_seconds()
    except:
        st_obj = datetime(1970, 1, 1, tzinfo=timezone.utc)
        et_obj = datetime.now(timezone.utc)

    # RAW/AGGREGATION SWITCH (1800 seconds = 30 minutes)
    raw = dur <= 1800 
    conn = None
    
    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            if raw:
                # RAW QUERY block (unchanged)
                sql = """SELECT h.ts, tl.tag, COALESCE(h.value_float, h.value_int::double precision, h.value_bool::int::double precision) 
                         FROM historian.historian h JOIN historian.tag_lookup tl ON h.tag_id = tl.id 
                         WHERE tl.tag = ANY(%s) AND h.ts >= %s AND h.ts <= %s ORDER BY h.ts ASC"""
                params = (tags, st_obj, et_obj)
            else:
                # AGGREGATED QUERY block - FIX: Aggressive Hierarchical Time Buckets
                
                # Check for All Time (2 years in the frontend logic) and huge queries first
                if dur > 86400 * 365 * 2: # > 2 years (This should catch the 'All Time' span)
                    buck = "1 month" 
                elif dur > 86400 * 30: # > 1 month
                    buck = "1 week" 
                elif dur > 86400 * 7: # > 1 week
                    buck = "6 hours" # 7 days * 4 per day = 28 points. Very fast.
                elif dur > 86400 * 2: # > 2 days
                    buck = "1 hour" # 2 days * 24 per day = 48 points. Fast.
                else:
                    buck = "5 minutes" # Default for > 30 minutes up to 2 days. 
                
                sql = """
                    SELECT 
                        time_bucket(%s, h.ts) as b, 
                        tl.tag, 
                        -- FIX: CHANGE AVG() to MAX() for more robust aggregation over long periods
                        MAX( 
                            CASE
                                WHEN h.value_float IS NOT NULL THEN h.value_float
                                WHEN h.value_int IS NOT NULL THEN h.value_int::double precision
                                WHEN h.value_bool IS NOT NULL THEN h.value_bool::int::double precision
                                ELSE NULL
                            END
                        )
                    FROM historian.historian h 
                    JOIN historian.tag_lookup tl ON h.tag_id = tl.id
                    WHERE tl.tag = ANY(%s) 
                      AND h.ts >= %s 
                      AND h.ts <= %s 
                    GROUP BY b, tl.tag 
                    ORDER BY b ASC
                """
                # Trust the original parameter order for safety:
                params = (buck, tags, st_obj, et_obj) 
            
            # --- DEBUG FIX: LOG THE EXECUTED QUERY ---
            print("\n--- DEBUG: HISTORIAN QUERY ---")
            print(cur.mogrify(sql, params).decode('utf-8'))
            print("------------------------------\n")
            # --- END DEBUG FIX ---

            cur.execute(sql, params)
            res = {t: [] for t in tags}
            for r in cur.fetchall():
                if r[2] is not None:
                    res[r[1]].append({"ts": r[0].isoformat(), "value": r[2]})
            return res
    except Exception as e:
        print(f"🔴 Query Error: {e}")
        return {"error": str(e)}
    finally:
        release_db_conn(conn)

@app.get("/api/live-data")
def live_endpoint():
    with live_data_lock: return live_data

@app.post("/api/write-tag", dependencies=[Depends(require_api_key), Depends(get_current_active_engineer)])
def write_tag_endpoint(req: TagWriteRequest):
    if req.tag_name not in WRITEABLE_TAGS: raise HTTPException(403, "Not writable")
    c = PLC()
    c.IPAddress = PLC_IP
    c.ProcessorSlot = 0
    
    status = "error"
    message = "Unknown error"
    
    try:
        ret = c.Write(req.tag_name, req.value)
        if getattr(ret, "Status", None) == 'Success': 
            status = "success"
            message = "Success"
        else:
            message = str(getattr(ret, "Status", "Unknown Status"))
    except Exception as e:
        message = str(e)
    finally:
        # FIX 2.3: Ensure the PLC connection is closed regardless of success/fail
        try:
            c.Close()
        except:
            # If close fails, we just ignore it and return the original error.
            pass 
            
    if status == 'success':
        return {"status": "success"}
    
    # If the write failed, raise a detailed error to the client
    raise HTTPException(status_code=500, detail={"status": status, "message": message})

@app.get("/api/settings", response_model=List[Setting])
def get_settings_endpoint(user: User = Depends(get_current_active_engineer)):
    conn = None
    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            cur.execute("SELECT key, value_float, value_text FROM app.settings")
            return [Setting(key=r[0], value=r[1] if r[1] is not None else r[2]) for r in cur.fetchall()]
    finally:
        release_db_conn(conn)

@app.put("/api/settings/{key}", response_model=Setting)
def update_setting_endpoint(key: str, s: Setting, user: User = Depends(get_current_active_engineer)):
    conn = None
    try:
        conn = get_db_conn()
        with conn.cursor() as cur:
            if isinstance(s.value, (float, int)):
                cur.execute("UPDATE app.settings SET value_float = %s WHERE key = %s", (s.value, key))
            else:
                cur.execute("UPDATE app.settings SET value_text = %s WHERE key = %s", (s.value, key))
            conn.commit()
        return s
    finally:
        release_db_conn(conn)

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
</file>

</files>
